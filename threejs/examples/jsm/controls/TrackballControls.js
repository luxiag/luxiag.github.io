import{EventDispatcher,MathUtils,MOUSE,Quaternion,Vector2,Vector3}from"three";const _changeEvent={type:"change"},_startEvent={type:"start"},_endEvent={type:"end"};class TrackballControls extends EventDispatcher{constructor(e,t){super();const o=this,n=-1;this.object=e,this.domElement=t,this.domElement.style.touchAction="none",this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.keys=["KeyA","KeyS","KeyD"],this.mouseButtons={LEFT:MOUSE.ROTATE,MIDDLE:MOUSE.DOLLY,RIGHT:MOUSE.PAN},this.target=new Vector3;const c=1e-6,i=new Vector3;let a=1,s=n,r=n,p=0,d=0,m=0;const l=new Vector3,h=new Vector2,u=new Vector2,g=new Vector3,y=new Vector2,b=new Vector2,E=new Vector2,v=new Vector2,w=[],f={};this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.zoom0=this.object.zoom,this.handleResize=function(){const e=o.domElement.getBoundingClientRect(),t=o.domElement.ownerDocument.documentElement;o.screen.left=e.left+window.pageXOffset-t.clientLeft,o.screen.top=e.top+window.pageYOffset-t.clientTop,o.screen.width=e.width,o.screen.height=e.height};const j=function(){const e=new Vector2;return function(t,n){return e.set((t-o.screen.left)/o.screen.width,(n-o.screen.top)/o.screen.height),e}}(),L=function(){const e=new Vector2;return function(t,n){return e.set((t-.5*o.screen.width-o.screen.left)/(.5*o.screen.width),(o.screen.height+2*(o.screen.top-n))/o.screen.width),e}}();function V(e){!1!==o.enabled&&(0===w.length&&(o.domElement.setPointerCapture(e.pointerId),o.domElement.addEventListener("pointermove",k),o.domElement.addEventListener("pointerup",x)),function(e){w.push(e)}(e),"touch"===e.pointerType?function(e){if(1===(T(e),w.length))s=3,u.copy(L(w[0].pageX,w[0].pageY)),h.copy(u);else{s=4;const e=w[0].pageX-w[1].pageX,t=w[0].pageY-w[1].pageY;d=p=Math.sqrt(e*e+t*t);const o=(w[0].pageX+w[1].pageX)/2,n=(w[0].pageY+w[1].pageY)/2;E.copy(j(o,n)),v.copy(E)}o.dispatchEvent(_startEvent)}(e):function(e){if(s===n)switch(e.button){case o.mouseButtons.LEFT:s=0;break;case o.mouseButtons.MIDDLE:s=1;break;case o.mouseButtons.RIGHT:s=2}const t=r!==n?r:s;0!==t||o.noRotate?1!==t||o.noZoom?2!==t||o.noPan||(E.copy(j(e.pageX,e.pageY)),v.copy(E)):(y.copy(j(e.pageX,e.pageY)),b.copy(y)):(u.copy(L(e.pageX,e.pageY)),h.copy(u)),o.dispatchEvent(_startEvent)}(e))}function k(e){!1!==o.enabled&&("touch"===e.pointerType?function(e){if(1===(T(e),w.length))h.copy(u),u.copy(L(e.pageX,e.pageY));else{const t=function(e){const t=e.pointerId===w[0].pointerId?w[1]:w[0];return f[t.pointerId]}(e),o=e.pageX-t.x,n=e.pageY-t.y;d=Math.sqrt(o*o+n*n);const c=(e.pageX+t.x)/2,i=(e.pageY+t.y)/2;v.copy(j(c,i))}}(e):function(e){const t=r!==n?r:s;0!==t||o.noRotate?1!==t||o.noZoom?2!==t||o.noPan||v.copy(j(e.pageX,e.pageY)):b.copy(j(e.pageX,e.pageY)):(h.copy(u),u.copy(L(e.pageX,e.pageY)))}(e))}function x(e){!1!==o.enabled&&("touch"===e.pointerType?function(e){switch(w.length){case 0:s=n;break;case 1:s=3,u.copy(L(e.pageX,e.pageY)),h.copy(u);break;case 2:s=4;for(let t=0;t<w.length;t++)if(w[t].pointerId!==e.pointerId){const e=f[w[t].pointerId];u.copy(L(e.x,e.y)),h.copy(u);break}}o.dispatchEvent(_endEvent)}(e):(s=n,o.dispatchEvent(_endEvent)),S(e),0===w.length&&(o.domElement.releasePointerCapture(e.pointerId),o.domElement.removeEventListener("pointermove",k),o.domElement.removeEventListener("pointerup",x)))}function z(e){S(e)}function D(e){!1!==o.enabled&&(window.removeEventListener("keydown",D),r===n&&(e.code!==o.keys[0]||o.noRotate?e.code!==o.keys[1]||o.noZoom?e.code!==o.keys[2]||o.noPan||(r=2):r=1:r=0))}function C(){!1!==o.enabled&&(r=n,window.addEventListener("keydown",D))}function Y(e){if(!1!==o.enabled&&!0!==o.noZoom){switch(e.preventDefault(),e.deltaMode){case 2:y.y-=.025*e.deltaY;break;case 1:y.y-=.01*e.deltaY;break;default:y.y-=25e-5*e.deltaY}o.dispatchEvent(_startEvent),o.dispatchEvent(_endEvent)}}function M(e){!1!==o.enabled&&e.preventDefault()}function S(e){delete f[e.pointerId];for(let t=0;t<w.length;t++)if(w[t].pointerId==e.pointerId)return void w.splice(t,1)}function T(e){let t=f[e.pointerId];void 0===t&&(t=new Vector2,f[e.pointerId]=t),t.set(e.pageX,e.pageY)}this.rotateCamera=function(){const e=new Vector3,t=new Quaternion,n=new Vector3,c=new Vector3,i=new Vector3,a=new Vector3;return function(){a.set(u.x-h.x,u.y-h.y,0);let s=a.length();s?(l.copy(o.object.position).sub(o.target),n.copy(l).normalize(),c.copy(o.object.up).normalize(),i.crossVectors(c,n).normalize(),c.setLength(u.y-h.y),i.setLength(u.x-h.x),a.copy(c.add(i)),e.crossVectors(a,l).normalize(),s*=o.rotateSpeed,t.setFromAxisAngle(e,s),l.applyQuaternion(t),o.object.up.applyQuaternion(t),g.copy(e),m=s):!o.staticMoving&&m&&(m*=Math.sqrt(1-o.dynamicDampingFactor),l.copy(o.object.position).sub(o.target),t.setFromAxisAngle(g,m),l.applyQuaternion(t),o.object.up.applyQuaternion(t)),h.copy(u)}}(),this.zoomCamera=function(){let e;4===s?(e=p/d,p=d,o.object.isPerspectiveCamera?l.multiplyScalar(e):o.object.isOrthographicCamera?(o.object.zoom=MathUtils.clamp(o.object.zoom/e,o.minZoom,o.maxZoom),a!==o.object.zoom&&o.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type")):(e=1+(b.y-y.y)*o.zoomSpeed,1!==e&&e>0&&(o.object.isPerspectiveCamera?l.multiplyScalar(e):o.object.isOrthographicCamera?(o.object.zoom=MathUtils.clamp(o.object.zoom/e,o.minZoom,o.maxZoom),a!==o.object.zoom&&o.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type")),o.staticMoving?y.copy(b):y.y+=(b.y-y.y)*this.dynamicDampingFactor)},this.panCamera=function(){const e=new Vector2,t=new Vector3,n=new Vector3;return function(){if(e.copy(v).sub(E),e.lengthSq()){if(o.object.isOrthographicCamera){const t=(o.object.right-o.object.left)/o.object.zoom/o.domElement.clientWidth,n=(o.object.top-o.object.bottom)/o.object.zoom/o.domElement.clientWidth;e.x*=t,e.y*=n}e.multiplyScalar(l.length()*o.panSpeed),n.copy(l).cross(o.object.up).setLength(e.x),n.add(t.copy(o.object.up).setLength(e.y)),o.object.position.add(n),o.target.add(n),o.staticMoving?E.copy(v):E.add(e.subVectors(v,E).multiplyScalar(o.dynamicDampingFactor))}}}(),this.checkDistances=function(){o.noZoom&&o.noPan||(l.lengthSq()>o.maxDistance*o.maxDistance&&(o.object.position.addVectors(o.target,l.setLength(o.maxDistance)),y.copy(b)),l.lengthSq()<o.minDistance*o.minDistance&&(o.object.position.addVectors(o.target,l.setLength(o.minDistance)),y.copy(b)))},this.update=function(){l.subVectors(o.object.position,o.target),o.noRotate||o.rotateCamera(),o.noZoom||o.zoomCamera(),o.noPan||o.panCamera(),o.object.position.addVectors(o.target,l),o.object.isPerspectiveCamera?(o.checkDistances(),o.object.lookAt(o.target),i.distanceToSquared(o.object.position)>c&&(o.dispatchEvent(_changeEvent),i.copy(o.object.position))):o.object.isOrthographicCamera?(o.object.lookAt(o.target),(i.distanceToSquared(o.object.position)>c||a!==o.object.zoom)&&(o.dispatchEvent(_changeEvent),i.copy(o.object.position),a=o.object.zoom)):console.warn("THREE.TrackballControls: Unsupported camera type")},this.reset=function(){s=n,r=n,o.target.copy(o.target0),o.object.position.copy(o.position0),o.object.up.copy(o.up0),o.object.zoom=o.zoom0,o.object.updateProjectionMatrix(),l.subVectors(o.object.position,o.target),o.object.lookAt(o.target),o.dispatchEvent(_changeEvent),i.copy(o.object.position),a=o.object.zoom},this.dispose=function(){o.domElement.removeEventListener("contextmenu",M),o.domElement.removeEventListener("pointerdown",V),o.domElement.removeEventListener("pointercancel",z),o.domElement.removeEventListener("wheel",Y),o.domElement.removeEventListener("pointermove",k),o.domElement.removeEventListener("pointerup",x),window.removeEventListener("keydown",D),window.removeEventListener("keyup",C)},this.domElement.addEventListener("contextmenu",M),this.domElement.addEventListener("pointerdown",V),this.domElement.addEventListener("pointercancel",z),this.domElement.addEventListener("wheel",Y,{passive:!1}),window.addEventListener("keydown",D),window.addEventListener("keyup",C),this.handleResize(),this.update()}}export{TrackballControls};