import{AnimationMixer,Box3,Mesh,MeshLambertMaterial,Object3D,TextureLoader,UVMapping,SRGBColorSpace}from"three";import{MD2Loader}from"../loaders/MD2Loader.js";class MD2Character{constructor(){this.scale=1,this.animationFPS=6,this.root=new Object3D,this.meshBody=null,this.meshWeapon=null,this.skinsBody=[],this.skinsWeapon=[],this.weapons=[],this.activeAnimation=null,this.mixer=null,this.onLoadComplete=function(){},this.loadCounter=0}loadParts(e){const t=this;function s(e,t){const s=new MeshLambertMaterial({color:16755200,wireframe:!0}),i=new MeshLambertMaterial({color:16777215,wireframe:!1,map:t}),o=new Mesh(e,i);return o.rotation.y=-Math.PI/2,o.castShadow=!0,o.receiveShadow=!0,o.materialTexture=i,o.materialWireframe=s,o}function i(e,t){const s=new TextureLoader,i=[];for(let a=0;a<t.length;a++)i[a]=s.load(e+t[a],o),i[a].mapping=UVMapping,i[a].name=t[a],i[a].colorSpace=SRGBColorSpace;return i}function o(){t.loadCounter-=1,0===t.loadCounter&&t.onLoadComplete()}this.loadCounter=2*e.weapons.length+e.skins.length+1;const a=[];for(let t=0;t<e.weapons.length;t++)a[t]=e.weapons[t][1];this.skinsBody=i(e.baseUrl+"skins/",e.skins),this.skinsWeapon=i(e.baseUrl+"skins/",a);const n=new MD2Loader;n.load(e.baseUrl+e.body,(function(e){const i=new Box3;i.setFromBufferAttribute(e.attributes.position),t.root.position.y=-t.scale*i.min.y;const a=s(e,t.skinsBody[0]);a.scale.set(t.scale,t.scale,t.scale),t.root.add(a),t.meshBody=a,t.meshBody.clipOffset=0,t.activeAnimationClipName=a.geometry.animations[0].name,t.mixer=new AnimationMixer(a),o()}));const h=function(e,i){return function(a){const n=s(a,t.skinsWeapon[e]);n.scale.set(t.scale,t.scale,t.scale),n.visible=!1,n.name=i,t.root.add(n),t.weapons[e]=n,t.meshWeapon=n,o()}};for(let t=0;t<e.weapons.length;t++)n.load(e.baseUrl+e.weapons[t][0],h(t,e.weapons[t][0]))}setPlaybackRate(e){this.mixer.timeScale=0!==e?1/e:0}setWireframe(e){e?(this.meshBody&&(this.meshBody.material=this.meshBody.materialWireframe),this.meshWeapon&&(this.meshWeapon.material=this.meshWeapon.materialWireframe)):(this.meshBody&&(this.meshBody.material=this.meshBody.materialTexture),this.meshWeapon&&(this.meshWeapon.material=this.meshWeapon.materialTexture))}setSkin(e){this.meshBody&&!1===this.meshBody.material.wireframe&&(this.meshBody.material.map=this.skinsBody[e])}setWeapon(e){for(let e=0;e<this.weapons.length;e++)this.weapons[e].visible=!1;const t=this.weapons[e];t&&(t.visible=!0,this.meshWeapon=t,this.syncWeaponAnimation())}setAnimation(e){if(this.meshBody){this.meshBody.activeAction&&(this.meshBody.activeAction.stop(),this.meshBody.activeAction=null);const t=this.mixer.clipAction(e,this.meshBody);t&&(this.meshBody.activeAction=t.play())}this.activeClipName=e,this.syncWeaponAnimation()}syncWeaponAnimation(){const e=this.activeClipName;if(this.meshWeapon){this.meshWeapon.activeAction&&(this.meshWeapon.activeAction.stop(),this.meshWeapon.activeAction=null);const t=this.mixer.clipAction(e,this.meshWeapon);t&&(this.meshWeapon.activeAction=t.syncWith(this.meshBody.activeAction).play())}}update(e){this.mixer&&this.mixer.update(e)}}export{MD2Character};