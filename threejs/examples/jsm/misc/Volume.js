import{Matrix3,Matrix4,Vector3}from"three";import{VolumeSlice}from"../misc/VolumeSlice.js";class Volume{constructor(t,e,i,s,n){if(void 0!==t){switch(this.xLength=Number(t)||1,this.yLength=Number(e)||1,this.zLength=Number(i)||1,this.axisOrder=["x","y","z"],s){case"Uint8":case"uint8":case"uchar":case"unsigned char":case"uint8_t":default:this.data=new Uint8Array(n);break;case"Int8":case"int8":case"signed char":case"int8_t":this.data=new Int8Array(n);break;case"Int16":case"int16":case"short":case"short int":case"signed short":case"signed short int":case"int16_t":this.data=new Int16Array(n);break;case"Uint16":case"uint16":case"ushort":case"unsigned short":case"unsigned short int":case"uint16_t":this.data=new Uint16Array(n);break;case"Int32":case"int32":case"int":case"signed int":case"int32_t":this.data=new Int32Array(n);break;case"Uint32":case"uint32":case"uint":case"unsigned int":case"uint32_t":this.data=new Uint32Array(n);break;case"longlong":case"long long":case"long long int":case"signed long long":case"signed long long int":case"int64":case"int64_t":case"ulonglong":case"unsigned long long":case"unsigned long long int":case"uint64":case"uint64_t":throw new Error("Error in Volume constructor : this type is not supported in JavaScript");case"Float32":case"float32":case"float":this.data=new Float32Array(n);break;case"Float64":case"float64":case"double":this.data=new Float64Array(n)}if(this.data.length!==this.xLength*this.yLength*this.zLength)throw new Error("Error in Volume constructor, lengths are not matching arrayBuffer size")}this.spacing=[1,1,1],this.offset=[0,0,0],this.matrix=new Matrix3,this.matrix.identity();let a=-1/0;Object.defineProperty(this,"lowerThreshold",{get:function(){return a},set:function(t){a=t,this.sliceList.forEach((function(t){t.geometryNeedsUpdate=!0}))}});let r=1/0;Object.defineProperty(this,"upperThreshold",{get:function(){return r},set:function(t){r=t,this.sliceList.forEach((function(t){t.geometryNeedsUpdate=!0}))}}),this.sliceList=[],this.segmentation=!1}getData(t,e,i){return this.data[i*this.xLength*this.yLength+e*this.xLength+t]}access(t,e,i){return i*this.xLength*this.yLength+e*this.xLength+t}reverseAccess(t){const e=Math.floor(t/(this.yLength*this.xLength)),i=Math.floor((t-e*this.yLength*this.xLength)/this.xLength);return[t-e*this.yLength*this.xLength-i*this.xLength,i,e]}map(t,e){const i=this.data.length;e=e||this;for(let s=0;s<i;s++)this.data[s]=t.call(e,this.data[s],s,this.data);return this}extractPerpendicularPlane(t,e){let i,s,n,a;const r=new Vector3,h=new Vector3,o=new Vector3,c=(new Matrix4).identity(),l=this,g=new Vector3(this.xLength,this.yLength,this.zLength);switch(t){case"x":r.set(1,0,0),h.set(0,0,-1),o.set(0,-1,0),i=this.spacing[this.axisOrder.indexOf("z")],s=this.spacing[this.axisOrder.indexOf("y")],a=new Vector3(e,0,0),c.multiply((new Matrix4).makeRotationY(Math.PI/2)),n=(l.RASDimensions[0]-1)/2,c.setPosition(new Vector3(e-n,0,0));break;case"y":r.set(0,1,0),h.set(1,0,0),o.set(0,0,1),i=this.spacing[this.axisOrder.indexOf("x")],s=this.spacing[this.axisOrder.indexOf("z")],a=new Vector3(0,e,0),c.multiply((new Matrix4).makeRotationX(-Math.PI/2)),n=(l.RASDimensions[1]-1)/2,c.setPosition(new Vector3(0,e-n,0));break;default:r.set(0,0,1),h.set(1,0,0),o.set(0,-1,0),i=this.spacing[this.axisOrder.indexOf("x")],s=this.spacing[this.axisOrder.indexOf("y")],a=new Vector3(0,0,e),n=(l.RASDimensions[2]-1)/2,c.setPosition(new Vector3(0,0,e-n))}let d,u;this.segmentation||(h.applyMatrix4(l.inverseMatrix).normalize(),o.applyMatrix4(l.inverseMatrix).normalize(),r.applyMatrix4(l.inverseMatrix).normalize()),h.arglet="i",o.arglet="j",d=Math.floor(Math.abs(h.dot(g))),u=Math.floor(Math.abs(o.dot(g)));const x=Math.abs(d*i),f=Math.abs(u*s);a=Math.abs(Math.round(a.applyMatrix4(l.inverseMatrix).dot(r)));const m=[new Vector3(1,0,0),new Vector3(0,1,0),new Vector3(0,0,1)],p=[h,o,r].find((function(t){return Math.abs(t.dot(m[0]))>.9})),y=[h,o,r].find((function(t){return Math.abs(t.dot(m[1]))>.9})),w=[h,o,r].find((function(t){return Math.abs(t.dot(m[2]))>.9}));return{iLength:d,jLength:u,sliceAccess:function(t,e){const i=p===r?a:"i"===p.arglet?t:e,s=y===r?a:"i"===y.arglet?t:e,n=w===r?a:"i"===w.arglet?t:e,h=p.dot(m[0])>0?i:l.xLength-1-i,o=y.dot(m[1])>0?s:l.yLength-1-s,c=w.dot(m[2])>0?n:l.zLength-1-n;return l.access(h,o,c)},matrix:c,planeWidth:x,planeHeight:f}}extractSlice(t,e){const i=new VolumeSlice(this,e,t);return this.sliceList.push(i),i}repaintAllSlices(){return this.sliceList.forEach((function(t){t.repaint()})),this}computeMinMax(){let t=1/0,e=-1/0;const i=this.data.length;let s=0;for(s=0;s<i;s++)if(!isNaN(this.data[s])){const i=this.data[s];t=Math.min(t,i),e=Math.max(e,i)}return this.min=t,this.max=e,[t,e]}}export{Volume};