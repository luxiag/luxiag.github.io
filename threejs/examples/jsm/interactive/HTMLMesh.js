import{CanvasTexture,LinearFilter,Mesh,MeshBasicMaterial,PlaneGeometry,SRGBColorSpace,Color}from"three";class HTMLMesh extends Mesh{constructor(e){const t=new HTMLTexture(e),o=new PlaneGeometry(.001*t.image.width,.001*t.image.height),n=new MeshBasicMaterial({map:t,toneMapped:!1,transparent:!0});function i(e){n.map.dispatchDOMEvent(e)}super(o,n),this.addEventListener("mousedown",i),this.addEventListener("mousemove",i),this.addEventListener("mouseup",i),this.addEventListener("click",i),this.dispose=function(){o.dispose(),n.dispose(),n.map.dispose(),canvases.delete(e),this.removeEventListener("mousedown",i),this.removeEventListener("mousemove",i),this.removeEventListener("mouseup",i),this.removeEventListener("click",i)}}}class HTMLTexture extends CanvasTexture{constructor(e){super(html2canvas(e)),this.dom=e,this.anisotropy=16,this.colorSpace=SRGBColorSpace,this.minFilter=LinearFilter,this.magFilter=LinearFilter;const t=new MutationObserver((()=>{this.scheduleUpdate||(this.scheduleUpdate=setTimeout((()=>this.update()),16))}));t.observe(e,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),this.observer=t}dispatchDOMEvent(e){e.data&&htmlevent(this.dom,e.type,e.data.x,e.data.y)}update(){this.image=html2canvas(this.dom),this.needsUpdate=!0,this.scheduleUpdate=null}dispose(){this.observer&&this.observer.disconnect(),this.scheduleUpdate=clearTimeout(this.scheduleUpdate),super.dispose()}}const canvases=new WeakMap;function html2canvas(e){const t=document.createRange(),o=new Color;function n(e,t,o,n){""!==n&&("uppercase"===e.textTransform&&(n=n.toUpperCase()),a.font=e.fontWeight+" "+e.fontSize+" "+e.fontFamily,a.textBaseline="top",a.fillStyle=e.color,a.fillText(n,t,o+.1*parseFloat(e.fontSize)))}function i(e,t,o,n,i){o<2*i&&(i=o/2),n<2*i&&(i=n/2),a.beginPath(),a.moveTo(e+i,t),a.arcTo(e+o,t,e+o,t+n,i),a.arcTo(e+o,t+n,e,t+n,i),a.arcTo(e,t+n,e,t,i),a.arcTo(e,t,e+o,t,i),a.closePath()}function s(e,t,o,n,i,s){const r=e[t+"Width"],l=e[t+"Style"],d=e[t+"Color"];"0px"!==r&&"none"!==l&&"transparent"!==d&&"rgba(0, 0, 0, 0)"!==d&&(a.strokeStyle=d,a.lineWidth=parseFloat(r),a.beginPath(),a.moveTo(o,n),a.lineTo(o+i,n+s),a.stroke())}const r=e.getBoundingClientRect();let l=canvases.get(e);void 0===l&&(l=document.createElement("canvas"),l.width=r.width,l.height=r.height,canvases.set(e,l));const a=l.getContext("2d"),d=new function(e){const t=[];let o=!1;function n(){if(o&&(o=!1,e.restore()),0===t.length)return;let n=-1/0,i=-1/0,s=1/0,r=1/0;for(let e=0;e<t.length;e++){const o=t[e];n=Math.max(n,o.x),i=Math.max(i,o.y),s=Math.min(s,o.x+o.width),r=Math.min(r,o.y+o.height)}e.save(),e.beginPath(),e.rect(n,i,s-n,r-i),e.clip(),o=!0}return{add:function(e){t.push(e),n()},remove:function(){t.pop(),n()}}}(a);return function e(l,c){let h=0,p=0,f=0,u=0;if(l.nodeType===Node.TEXT_NODE){t.selectNode(l);const e=t.getBoundingClientRect();h=e.left-r.left-.5,p=e.top-r.top-.5,f=e.width,u=e.height,n(c,h,p,l.nodeValue.trim())}else{if(l.nodeType===Node.COMMENT_NODE)return;if(l instanceof HTMLCanvasElement){if("none"===l.style.display)return;a.save();const e=window.devicePixelRatio;a.scale(1/e,1/e),a.drawImage(l,0,0),a.restore()}else if(l instanceof HTMLImageElement){if("none"===l.style.display)return;a.drawImage(l,0,0,l.width,l.height)}else{if("none"===l.style.display)return;const e=l.getBoundingClientRect();h=e.left-r.left-.5,p=e.top-r.top-.5,f=e.width,u=e.height,c=window.getComputedStyle(l),i(h,p,f,u,parseFloat(c.borderRadius));const t=c.backgroundColor;"transparent"!==t&&"rgba(0, 0, 0, 0)"!==t&&(a.fillStyle=t,a.fill());const m=["borderTop","borderLeft","borderBottom","borderRight"];let g=!0,v=null;for(const e of m){if(null!==v&&(g=c[e+"Width"]===c[v+"Width"]&&c[e+"Color"]===c[v+"Color"]&&c[e+"Style"]===c[v+"Style"]),!1===g)break;v=e}if(!0===g){const e=parseFloat(c.borderTopWidth);"0px"!==c.borderTopWidth&&"none"!==c.borderTopStyle&&"transparent"!==c.borderTopColor&&"rgba(0, 0, 0, 0)"!==c.borderTopColor&&(a.strokeStyle=c.borderTopColor,a.lineWidth=e,a.stroke())}else s(c,"borderTop",h,p,f,0),s(c,"borderLeft",h,p,0,u),s(c,"borderBottom",h,p+u,f,0),s(c,"borderRight",h+f,p,0,u);if(l instanceof HTMLInputElement){let e=c.accentColor;void 0!==e&&"auto"!==e||(e=c.color),o.set(e);const t=Math.sqrt(.299*o.r**2+.587*o.g**2+.114*o.b**2)<.5?"white":"#111111";if("radio"===l.type&&(i(h,p,f,u,u),a.fillStyle="white",a.strokeStyle=e,a.lineWidth=1,a.fill(),a.stroke(),l.checked&&(i(h+2,p+2,f-4,u-4,u),a.fillStyle=e,a.strokeStyle=t,a.lineWidth=2,a.fill(),a.stroke())),"checkbox"===l.type&&(i(h,p,f,u,2),a.fillStyle=l.checked?e:"white",a.strokeStyle=l.checked?t:e,a.lineWidth=1,a.stroke(),a.fill(),l.checked)){const e=a.textAlign;a.textAlign="center",n({color:t,fontFamily:c.fontFamily,fontSize:u+"px",fontWeight:"bold"},h+f/2,p,"âœ”"),a.textAlign=e}if("range"===l.type){const[o,n,s]=["min","max","value"].map((e=>parseFloat(l[e]))),r=(s-o)/(n-o)*(f-u);i(h,p+u/4,f,u/2,u/4),a.fillStyle=t,a.strokeStyle=e,a.lineWidth=1,a.fill(),a.stroke(),i(h,p+u/4,r+u/2,u/2,u/4),a.fillStyle=e,a.fill(),i(h+r,p,u,u,u/2),a.fillStyle=e,a.fill()}"color"!==l.type&&"text"!==l.type&&"number"!==l.type||(d.add({x:h,y:p,width:f,height:u}),n(c,h+parseInt(c.paddingLeft),p+parseInt(c.paddingTop),l.value),d.remove())}}}const m="auto"===c.overflow||"hidden"===c.overflow;m&&d.add({x:h,y:p,width:f,height:u});for(let t=0;t<l.childNodes.length;t++)e(l.childNodes[t],c);m&&d.remove()}(e),l}function htmlevent(e,t,o,n){const i={clientX:o*e.offsetWidth+e.offsetLeft,clientY:n*e.offsetHeight+e.offsetTop,view:e.ownerDocument.defaultView};window.dispatchEvent(new MouseEvent(t,i));const s=e.getBoundingClientRect();o=o*s.width+s.left,n=n*s.height+s.top,function e(s){if(s.nodeType!==Node.TEXT_NODE&&s.nodeType!==Node.COMMENT_NODE){const r=s.getBoundingClientRect();if(o>r.left&&o<r.right&&n>r.top&&n<r.bottom&&(s.dispatchEvent(new MouseEvent(t,i)),s instanceof HTMLInputElement&&"range"===s.type&&("mousedown"===t||"click"===t))){const[e,t]=["min","max"].map((e=>parseFloat(s[e]))),n=r.width,i=(o-r.x)/n;s.value=e+(t-e)*i,s.dispatchEvent(new InputEvent("input",{bubbles:!0}))}for(let t=0;t<s.childNodes.length;t++)e(s.childNodes[t])}}(e)}export{HTMLMesh};