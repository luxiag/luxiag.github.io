import{FloatType,HalfFloatType,UnsignedByteType,RGBAFormat,RGFormat,RGIntegerFormat,RedFormat,RedIntegerFormat,NoColorSpace,LinearSRGBColorSpace,SRGBColorSpace,DataTexture,REVISION}from"three";import{write,KTX2Container,KHR_DF_CHANNEL_RGBSDA_ALPHA,KHR_DF_CHANNEL_RGBSDA_BLUE,KHR_DF_CHANNEL_RGBSDA_GREEN,KHR_DF_CHANNEL_RGBSDA_RED,KHR_DF_MODEL_RGBSDA,KHR_DF_PRIMARIES_BT709,KHR_DF_PRIMARIES_UNSPECIFIED,KHR_DF_SAMPLE_DATATYPE_FLOAT,KHR_DF_SAMPLE_DATATYPE_LINEAR,KHR_DF_SAMPLE_DATATYPE_SIGNED,KHR_DF_TRANSFER_LINEAR,KHR_DF_TRANSFER_SRGB,VK_FORMAT_R16_SFLOAT,VK_FORMAT_R16G16_SFLOAT,VK_FORMAT_R16G16B16A16_SFLOAT,VK_FORMAT_R32_SFLOAT,VK_FORMAT_R32G32_SFLOAT,VK_FORMAT_R32G32B32A32_SFLOAT,VK_FORMAT_R8_SRGB,VK_FORMAT_R8_UNORM,VK_FORMAT_R8G8_SRGB,VK_FORMAT_R8G8_UNORM,VK_FORMAT_R8G8B8A8_SRGB,VK_FORMAT_R8G8B8A8_UNORM}from"../libs/ktx-parse.module.js";const VK_FORMAT_MAP={[RGBAFormat]:{[FloatType]:{[NoColorSpace]:VK_FORMAT_R32G32B32A32_SFLOAT,[LinearSRGBColorSpace]:VK_FORMAT_R32G32B32A32_SFLOAT},[HalfFloatType]:{[NoColorSpace]:VK_FORMAT_R16G16B16A16_SFLOAT,[LinearSRGBColorSpace]:VK_FORMAT_R16G16B16A16_SFLOAT},[UnsignedByteType]:{[NoColorSpace]:VK_FORMAT_R8G8B8A8_UNORM,[LinearSRGBColorSpace]:VK_FORMAT_R8G8B8A8_UNORM,[SRGBColorSpace]:VK_FORMAT_R8G8B8A8_SRGB}},[RGFormat]:{[FloatType]:{[NoColorSpace]:VK_FORMAT_R32G32_SFLOAT,[LinearSRGBColorSpace]:VK_FORMAT_R32G32_SFLOAT},[HalfFloatType]:{[NoColorSpace]:VK_FORMAT_R16G16_SFLOAT,[LinearSRGBColorSpace]:VK_FORMAT_R16G16_SFLOAT},[UnsignedByteType]:{[NoColorSpace]:VK_FORMAT_R8G8_UNORM,[LinearSRGBColorSpace]:VK_FORMAT_R8G8_UNORM,[SRGBColorSpace]:VK_FORMAT_R8G8_SRGB}},[RedFormat]:{[FloatType]:{[NoColorSpace]:VK_FORMAT_R32_SFLOAT,[LinearSRGBColorSpace]:VK_FORMAT_R32_SFLOAT},[HalfFloatType]:{[NoColorSpace]:VK_FORMAT_R16_SFLOAT,[LinearSRGBColorSpace]:VK_FORMAT_R16_SFLOAT},[UnsignedByteType]:{[NoColorSpace]:VK_FORMAT_R8_UNORM,[LinearSRGBColorSpace]:VK_FORMAT_R8_UNORM,[SRGBColorSpace]:VK_FORMAT_R8_SRGB}}},KHR_DF_CHANNEL_MAP={0:KHR_DF_CHANNEL_RGBSDA_RED,1:KHR_DF_CHANNEL_RGBSDA_GREEN,2:KHR_DF_CHANNEL_RGBSDA_BLUE,3:KHR_DF_CHANNEL_RGBSDA_ALPHA},ERROR_INPUT="THREE.KTX2Exporter: Supported inputs are DataTexture, Data3DTexture, or WebGLRenderer and WebGLRenderTarget.",ERROR_FORMAT="THREE.KTX2Exporter: Supported formats are RGBAFormat, RGFormat, or RedFormat.",ERROR_TYPE='THREE.KTX2Exporter: Supported types are FloatType, HalfFloatType, or UnsignedByteType."',ERROR_COLOR_SPACE="THREE.KTX2Exporter: Supported color spaces are SRGBColorSpace (UnsignedByteType only), LinearSRGBColorSpace, or NoColorSpace.";export class KTX2Exporter{parse(e,R){let _;if(e.isDataTexture||e.isData3DTexture)_=e;else{if(!e.isWebGLRenderer||!R.isWebGLRenderTarget)throw new Error(ERROR_INPUT);_=toDataTexture(e,R)}if(void 0===VK_FORMAT_MAP[_.format])throw new Error(ERROR_FORMAT);if(void 0===VK_FORMAT_MAP[_.format][_.type])throw new Error(ERROR_TYPE);if(void 0===VK_FORMAT_MAP[_.format][_.type][_.colorSpace])throw new Error(ERROR_COLOR_SPACE);const r=_.image.data,t=getChannelCount(_),o=new KTX2Container;o.vkFormat=VK_FORMAT_MAP[_.format][_.type][_.colorSpace],o.typeSize=r.BYTES_PER_ELEMENT,o.pixelWidth=_.image.width,o.pixelHeight=_.image.height,_.isData3DTexture&&(o.pixelDepth=_.image.depth);const a=o.dataFormatDescriptor[0];a.colorModel=KHR_DF_MODEL_RGBSDA,a.colorPrimaries=_.colorSpace===NoColorSpace?KHR_DF_PRIMARIES_UNSPECIFIED:KHR_DF_PRIMARIES_BT709,a.transferFunction=_.colorSpace===SRGBColorSpace?KHR_DF_TRANSFER_SRGB:KHR_DF_TRANSFER_LINEAR,a.texelBlockDimension=[0,0,0,0],a.bytesPlane=[o.typeSize*t,0,0,0,0,0,0,0];for(let e=0;e<t;++e){let R=KHR_DF_CHANNEL_MAP[e];_.colorSpace!==LinearSRGBColorSpace&&_.colorSpace!==NoColorSpace||(R|=KHR_DF_SAMPLE_DATATYPE_LINEAR),_.type!==FloatType&&_.type!==HalfFloatType||(R|=KHR_DF_SAMPLE_DATATYPE_FLOAT,R|=KHR_DF_SAMPLE_DATATYPE_SIGNED),a.samples.push({channelType:R,bitOffset:e*r.BYTES_PER_ELEMENT,bitLength:8*r.BYTES_PER_ELEMENT-1,samplePosition:[0,0,0,0],sampleLower:_.type===UnsignedByteType?0:-1,sampleUpper:_.type===UnsignedByteType?255:1})}return o.levels=[{levelData:new Uint8Array(r.buffer,r.byteOffset,r.byteLength),uncompressedByteLength:r.byteLength}],o.keyValue.KTXwriter=`three.js ${REVISION}`,write(o,{keepWriter:!0})}}function toDataTexture(e,R){const _=getChannelCount(R.texture);let r;if(R.texture.type===FloatType)r=new Float32Array(R.width*R.height*_);else if(R.texture.type===HalfFloatType)r=new Uint16Array(R.width*R.height*_);else{if(R.texture.type!==UnsignedByteType)throw new Error(ERROR_TYPE);r=new Uint8Array(R.width*R.height*_)}return e.readRenderTargetPixels(R,0,0,R.width,R.height,r),new DataTexture(r,R.width,R.height,R.texture.format,R.texture.type)}function getChannelCount(e){switch(e.format){case RGBAFormat:return 4;case RGFormat:case RGIntegerFormat:return 2;case RedFormat:case RedIntegerFormat:return 1;default:throw new Error(ERROR_FORMAT)}}