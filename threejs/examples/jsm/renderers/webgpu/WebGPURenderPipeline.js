import{GPUIndexFormat,GPUCompareFunction,GPUFrontFace,GPUCullMode,GPUVertexFormat,GPUBlendFactor,GPUBlendOperation,BlendColorFactor,OneMinusBlendColorFactor,GPUColorWriteFlags,GPUStencilOperation,GPUInputStepMode}from"./constants.js";import{FrontSide,BackSide,DoubleSide,NeverDepth,AlwaysDepth,LessDepth,LessEqualDepth,EqualDepth,GreaterEqualDepth,GreaterDepth,NotEqualDepth,NeverStencilFunc,AlwaysStencilFunc,LessStencilFunc,LessEqualStencilFunc,EqualStencilFunc,GreaterEqualStencilFunc,GreaterStencilFunc,NotEqualStencilFunc,KeepStencilOp,ZeroStencilOp,ReplaceStencilOp,InvertStencilOp,IncrementStencilOp,DecrementStencilOp,IncrementWrapStencilOp,DecrementWrapStencilOp,NoBlending,NormalBlending,AdditiveBlending,SubtractiveBlending,MultiplyBlending,CustomBlending,AddEquation,SubtractEquation,ReverseSubtractEquation,MinEquation,MaxEquation,ZeroFactor,OneFactor,SrcColorFactor,OneMinusSrcColorFactor,SrcAlphaFactor,OneMinusSrcAlphaFactor,DstAlphaFactor,OneMinusDstAlphaFactor,DstColorFactor,OneMinusDstColorFactor,SrcAlphaSaturateFactor}from"three";class WebGPURenderPipeline{constructor(e,t){this.cacheKey=null,this.shaderAttributes=null,this.stageVertex=null,this.stageFragment=null,this.usedTimes=0,this._device=e,this._utils=t}init(e,t,r,a,n){const{object:o,material:c,geometry:l}=a,i=this._getShaderAttributes(n,l),s=[];for(const e of i){const t=e.name,r=l.getAttribute(t),a=void 0!==r&&r.isInstancedBufferAttribute?GPUInputStepMode.Instance:GPUInputStepMode.Vertex;s.push({arrayStride:e.arrayStride,attributes:[{shaderLocation:e.slot,offset:e.offset,format:e.format}],stepMode:a})}this.cacheKey=e,this.shaderAttributes=i,this.stageVertex=t,this.stageFragment=r;let d={},p={};!0===c.transparent&&c.blending!==NoBlending&&(d=this._getAlphaBlend(c),p=this._getColorBlend(c));let u={};!0===c.stencilWrite&&(u={compare:this._getStencilCompare(c),failOp:this._getStencilOperation(c.stencilFail),depthFailOp:this._getStencilOperation(c.stencilZFail),passOp:this._getStencilOperation(c.stencilZPass)});const F=this._getPrimitiveState(o,l,c),G=this._getColorWriteMask(c),U=this._getDepthCompare(c),P=this._utils.getCurrentColorFormat(),S=this._utils.getCurrentDepthStencilFormat(),h=this._utils.getSampleCount();this.pipeline=this._device.createRenderPipeline({vertex:Object.assign({},t.stage,{buffers:s}),fragment:Object.assign({},r.stage,{targets:[{format:P,blend:{alpha:d,color:p},writeMask:G}]}),primitive:F,depthStencil:{format:S,depthWriteEnabled:c.depthWrite,depthCompare:U,stencilFront:u,stencilBack:{},stencilReadMask:c.stencilFuncMask,stencilWriteMask:c.stencilWriteMask},multisample:{count:h},layout:"auto"})}_getAlphaBlend(e){const t=e.blending,r=e.premultipliedAlpha;let a;switch(t){case NormalBlending:!1===r&&(a={srcFactor:GPUBlendFactor.One,dstFactor:GPUBlendFactor.OneMinusSrcAlpha,operation:GPUBlendOperation.Add});break;case AdditiveBlending:a={srcFactor:GPUBlendFactor.Zero,dstFactor:GPUBlendFactor.One,operation:GPUBlendOperation.Add};break;case SubtractiveBlending:!0===r&&(a={srcFactor:GPUBlendFactor.OneMinusSrcColor,dstFactor:GPUBlendFactor.OneMinusSrcAlpha,operation:GPUBlendOperation.Add});break;case MultiplyBlending:!0===r&&(a={srcFactor:GPUBlendFactor.Zero,dstFactor:GPUBlendFactor.SrcAlpha,operation:GPUBlendOperation.Add});break;case CustomBlending:const n=e.blendSrcAlpha,o=e.blendDstAlpha,c=e.blendEquationAlpha;null!==n&&null!==o&&null!==c&&(a={srcFactor:this._getBlendFactor(n),dstFactor:this._getBlendFactor(o),operation:this._getBlendOperation(c)});break;default:console.error("THREE.WebGPURenderer: Blending not supported.",t)}return a}_getBlendFactor(e){let t;switch(e){case ZeroFactor:t=GPUBlendFactor.Zero;break;case OneFactor:t=GPUBlendFactor.One;break;case SrcColorFactor:t=GPUBlendFactor.SrcColor;break;case OneMinusSrcColorFactor:t=GPUBlendFactor.OneMinusSrcColor;break;case SrcAlphaFactor:t=GPUBlendFactor.SrcAlpha;break;case OneMinusSrcAlphaFactor:t=GPUBlendFactor.OneMinusSrcAlpha;break;case DstColorFactor:t=GPUBlendFactor.DstColor;break;case OneMinusDstColorFactor:t=GPUBlendFactor.OneMinusDstColor;break;case DstAlphaFactor:t=GPUBlendFactor.DstAlpha;break;case OneMinusDstAlphaFactor:t=GPUBlendFactor.OneMinusDstAlpha;break;case SrcAlphaSaturateFactor:t=GPUBlendFactor.SrcAlphaSaturated;break;case BlendColorFactor:t=GPUBlendFactor.BlendColor;break;case OneMinusBlendColorFactor:t=GPUBlendFactor.OneMinusBlendColor;break;default:console.error("THREE.WebGPURenderer: Blend factor not supported.",e)}return t}_getBlendOperation(e){let t;switch(e){case AddEquation:t=GPUBlendOperation.Add;break;case SubtractEquation:t=GPUBlendOperation.Subtract;break;case ReverseSubtractEquation:t=GPUBlendOperation.ReverseSubtract;break;case MinEquation:t=GPUBlendOperation.Min;break;case MaxEquation:t=GPUBlendOperation.Max;break;default:console.error("THREE.WebGPURenderer: Blend equation not supported.",e)}return t}_getColorBlend(e){const t=e.blending,r=e.premultipliedAlpha,a={srcFactor:null,dstFactor:null,operation:null};switch(t){case NormalBlending:a.srcFactor=!0===r?GPUBlendFactor.One:GPUBlendFactor.SrcAlpha,a.dstFactor=GPUBlendFactor.OneMinusSrcAlpha,a.operation=GPUBlendOperation.Add;break;case AdditiveBlending:a.srcFactor=!0===r?GPUBlendFactor.One:GPUBlendFactor.SrcAlpha,a.dstFactor=GPUBlendFactor.One,a.operation=GPUBlendOperation.Add;break;case SubtractiveBlending:a.srcFactor=GPUBlendFactor.Zero,a.dstFactor=!0===r?GPUBlendFactor.Zero:GPUBlendFactor.OneMinusSrcColor,a.operation=GPUBlendOperation.Add;break;case MultiplyBlending:a.srcFactor=GPUBlendFactor.Zero,a.dstFactor=GPUBlendFactor.SrcColor,a.operation=GPUBlendOperation.Add;break;case CustomBlending:a.srcFactor=this._getBlendFactor(e.blendSrc),a.dstFactor=this._getBlendFactor(e.blendDst),a.operation=this._getBlendOperation(e.blendEquation);break;default:console.error("THREE.WebGPURenderer: Blending not supported.",t)}return a}_getColorWriteMask(e){return!0===e.colorWrite?GPUColorWriteFlags.All:GPUColorWriteFlags.None}_getDepthCompare(e){let t;if(!1===e.depthTest)t=GPUCompareFunction.Always;else{const r=e.depthFunc;switch(r){case NeverDepth:t=GPUCompareFunction.Never;break;case AlwaysDepth:t=GPUCompareFunction.Always;break;case LessDepth:t=GPUCompareFunction.Less;break;case LessEqualDepth:t=GPUCompareFunction.LessEqual;break;case EqualDepth:t=GPUCompareFunction.Equal;break;case GreaterEqualDepth:t=GPUCompareFunction.GreaterEqual;break;case GreaterDepth:t=GPUCompareFunction.Greater;break;case NotEqualDepth:t=GPUCompareFunction.NotEqual;break;default:console.error("THREE.WebGPURenderer: Invalid depth function.",r)}}return t}_getPrimitiveState(e,t,r){const a={};if(a.topology=this._utils.getPrimitiveTopology(e,r),!0===e.isLine&&!0!==e.isLineSegments){const e=t.index?t.index.count:t.attributes.position.count;a.stripIndexFormat=e>65535?GPUIndexFormat.Uint32:GPUIndexFormat.Uint16}switch(r.side){case FrontSide:a.frontFace=GPUFrontFace.CW,a.cullMode=GPUCullMode.Front;break;case BackSide:a.frontFace=GPUFrontFace.CW,a.cullMode=GPUCullMode.Back;break;case DoubleSide:a.frontFace=GPUFrontFace.CW,a.cullMode=GPUCullMode.None;break;default:console.error("THREE.WebGPURenderer: Unknown Material.side value.",r.side)}return a}_getStencilCompare(e){let t;const r=e.stencilFunc;switch(r){case NeverStencilFunc:t=GPUCompareFunction.Never;break;case AlwaysStencilFunc:t=GPUCompareFunction.Always;break;case LessStencilFunc:t=GPUCompareFunction.Less;break;case LessEqualStencilFunc:t=GPUCompareFunction.LessEqual;break;case EqualStencilFunc:t=GPUCompareFunction.Equal;break;case GreaterEqualStencilFunc:t=GPUCompareFunction.GreaterEqual;break;case GreaterStencilFunc:t=GPUCompareFunction.Greater;break;case NotEqualStencilFunc:t=GPUCompareFunction.NotEqual;break;default:console.error("THREE.WebGPURenderer: Invalid stencil function.",r)}return t}_getStencilOperation(e){let t;switch(e){case KeepStencilOp:t=GPUStencilOperation.Keep;break;case ZeroStencilOp:t=GPUStencilOperation.Zero;break;case ReplaceStencilOp:t=GPUStencilOperation.Replace;break;case InvertStencilOp:t=GPUStencilOperation.Invert;break;case IncrementStencilOp:t=GPUStencilOperation.IncrementClamp;break;case DecrementStencilOp:t=GPUStencilOperation.DecrementClamp;break;case IncrementWrapStencilOp:t=GPUStencilOperation.IncrementWrap;break;case DecrementWrapStencilOp:t=GPUStencilOperation.DecrementWrap;break;default:console.error("THREE.WebGPURenderer: Invalid stencil operation.",t)}return t}_getVertexFormat(e,t){return"float"===e?GPUVertexFormat.Float32:"vec2"===e?2===t?GPUVertexFormat.Float16x2:GPUVertexFormat.Float32x2:"vec3"===e?GPUVertexFormat.Float32x3:"vec4"===e?2===t?GPUVertexFormat.Float16x4:GPUVertexFormat.Float32x4:"int"===e?GPUVertexFormat.Sint32:"ivec2"===e?1===t?GPUVertexFormat.Sint8x2:2===t?GPUVertexFormat.Sint16x2:GPUVertexFormat.Sint32x2:"ivec3"===e?GPUVertexFormat.Sint32x3:"ivec4"===e?1===t?GPUVertexFormat.Sint8x4:2===t?GPUVertexFormat.Sint16x4:GPUVertexFormat.Sint32x4:"uint"===e?GPUVertexFormat.Uint32:"uvec2"===e?1===t?GPUVertexFormat.Uint8x2:2===t?GPUVertexFormat.Uint16x2:GPUVertexFormat.Uint32x2:"uvec3"===e?GPUVertexFormat.Uint32x3:"uvec4"===e?1===t?GPUVertexFormat.Uint8x4:2===t?GPUVertexFormat.Uint16x4:GPUVertexFormat.Uint32x4:void console.error("THREE.WebGPURenderer: Shader variable type not supported yet.",e)}_getShaderAttributes(e,t){const r=e.attributes,a=[];for(let e=0;e<r.length;e++){const n=r[e],o=n.name,c=n.type,l=t.getAttribute(o),i=l.array.BYTES_PER_ELEMENT,s=this._getVertexFormat(c,i);let d=l.itemSize*i,p=0;!0===l.isInterleavedBufferAttribute&&(d=l.data.stride*i,p=l.offset*i),a.push({name:o,arrayStride:d,offset:p,format:s,slot:e})}return a}}export default WebGPURenderPipeline;