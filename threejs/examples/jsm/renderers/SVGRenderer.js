import{Box2,Camera,Color,Matrix3,Matrix4,Object3D,Vector3}from"three";import{Projector}from"../renderers/Projector.js";import{RenderableFace}from"../renderers/Projector.js";import{RenderableLine}from"../renderers/Projector.js";import{RenderableSprite}from"../renderers/Projector.js";class SVGObject extends Object3D{constructor(e){super(),this.isSVGObject=!0,this.node=e}}class SVGRenderer{constructor(){let e,t,i,o,r,n,s,c,a,l,p,d,h,f=0,S=null,m=1;const u=this,y=new Box2,x=new Box2,g=new Color,w=new Color,b=new Color,M=new Color,v=new Color,j=new Color,C=new Vector3,z=new Vector3,P=new Vector3,L=new Matrix3,k=new Matrix4,R=new Matrix4,V=[],B=new Projector,G=document.createElementNS("http://www.w3.org/2000/svg","svg");function E(){for(f=0;G.childNodes.length>0;)G.removeChild(G.childNodes[0])}function A(e){return null!==S?e.toFixed(S):e}function F(e,t,i){let o=t.scale.x*n,r=t.scale.y*s;i.isPointsMaterial&&(o*=i.size,r*=i.size);const c="M"+A(e.x-.5*o)+","+A(e.y-.5*r)+"h"+A(o)+"v"+A(r)+"h"+A(-o)+"z";let a="";(i.isSpriteMaterial||i.isPointsMaterial)&&(a="fill:"+i.color.getStyle()+";fill-opacity:"+i.opacity),D(a,c)}function O(e,t,i){const o="M"+A(e.positionScreen.x)+","+A(e.positionScreen.y)+"L"+A(t.positionScreen.x)+","+A(t.positionScreen.y);if(i.isLineBasicMaterial){let e="fill:none;stroke:"+i.color.getStyle()+";stroke-opacity:"+i.opacity+";stroke-width:"+i.linewidth+";stroke-linecap:"+i.linecap;i.isLineDashedMaterial&&(e=e+";stroke-dasharray:"+i.dashSize+","+i.gapSize),D(e,o)}}function W(e,t,o,r,n){u.info.render.vertices+=3,u.info.render.faces++;const s="M"+A(e.positionScreen.x)+","+A(e.positionScreen.y)+"L"+A(t.positionScreen.x)+","+A(t.positionScreen.y)+"L"+A(o.positionScreen.x)+","+A(o.positionScreen.y)+"z";let c="";n.isMeshBasicMaterial?(g.copy(n.color),n.vertexColors&&g.multiply(r.color)):n.isMeshLambertMaterial||n.isMeshPhongMaterial||n.isMeshStandardMaterial?(w.copy(n.color),n.vertexColors&&w.multiply(r.color),g.copy(b),z.copy(e.positionWorld).add(t.positionWorld).add(o.positionWorld).divideScalar(3),function(e,t,i,o){for(let r=0,n=e.length;r<n;r++){const n=e[r],s=n.color;if(n.isDirectionalLight){const e=C.setFromMatrixPosition(n.matrixWorld).normalize();let t=i.dot(e);if(t<=0)continue;t*=n.intensity,o.r+=s.r*t,o.g+=s.g*t,o.b+=s.b*t}else if(n.isPointLight){const e=C.setFromMatrixPosition(n.matrixWorld);let r=i.dot(C.subVectors(e,t).normalize());if(r<=0)continue;if(r*=0==n.distance?1:1-Math.min(t.distanceTo(e)/n.distance,1),0==r)continue;r*=n.intensity,o.r+=s.r*r,o.g+=s.g*r,o.b+=s.b*r}}}(i,z,r.normalModel,g),g.multiply(w).add(n.emissive)):n.isMeshNormalMaterial&&(P.copy(r.normalModel).applyMatrix3(L).normalize(),g.setRGB(P.x,P.y,P.z).multiplyScalar(.5).addScalar(.5)),c=n.wireframe?"fill:none;stroke:"+g.getStyle()+";stroke-opacity:"+n.opacity+";stroke-width:"+n.wireframeLinewidth+";stroke-linecap:"+n.wireframeLinecap+";stroke-linejoin:"+n.wireframeLinejoin:"fill:"+g.getStyle()+";fill-opacity:"+n.opacity,D(c,s)}function N(e,t,i){let o=t.x-e.x,r=t.y-e.y;const n=o*o+r*r;if(0===n)return;const s=i/Math.sqrt(n);o*=s,r*=s,t.x+=o,t.y+=r,e.x-=o,e.y-=r}function D(e,t){h===e?d+=t:(I(),h=e,d=t)}function I(){var e;d&&(e=f++,p=null==V[e]?(V[e]=document.createElementNS("http://www.w3.org/2000/svg","path"),0==m&&V[e].setAttribute("shape-rendering","crispEdges"),V[e]):V[e],p.setAttribute("d",d),p.setAttribute("style",h),G.appendChild(p)),d="",h=""}this.domElement=G,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.overdraw=.5,this.info={render:{vertices:0,faces:0}},this.setQuality=function(e){switch(e){case"high":m=1;break;case"low":m=0}},this.setClearColor=function(e){j.set(e)},this.setPixelRatio=function(){},this.setSize=function(e,t){o=e,r=t,n=o/2,s=r/2,G.setAttribute("viewBox",-n+" "+-s+" "+o+" "+r),G.setAttribute("width",o),G.setAttribute("height",r),y.min.set(-n,-s),y.max.set(n,s)},this.getSize=function(){return{width:o,height:r}},this.setPrecision=function(e){S=e},this.clear=function(){E(),G.style.backgroundColor=j.getStyle()},this.render=function(o,r){if(r instanceof Camera==0)return void console.error("THREE.SVGRenderer.render: camera is not an instance of Camera.");const p=o.background;p&&p.isColor?(E(),G.style.backgroundColor=p.getStyle()):!0===this.autoClear&&this.clear(),u.info.render.vertices=0,u.info.render.faces=0,k.copy(r.matrixWorldInverse),R.multiplyMatrices(r.projectionMatrix,k),e=B.projectScene(o,r,this.sortObjects,this.sortElements),t=e.elements,i=e.lights,L.getNormalMatrix(r.matrixWorldInverse),function(e){b.setRGB(0,0,0),M.setRGB(0,0,0),v.setRGB(0,0,0);for(let t=0,i=e.length;t<i;t++){const i=e[t],o=i.color;i.isAmbientLight?(b.r+=o.r,b.g+=o.g,b.b+=o.b):i.isDirectionalLight?(M.r+=o.r,M.g+=o.g,M.b+=o.b):i.isPointLight&&(v.r+=o.r,v.g+=o.g,v.b+=o.b)}}(i),d="",h="";for(let e=0,i=t.length;e<i;e++){const i=t[e],o=i.material;if(void 0!==o&&0!==o.opacity)if(x.makeEmpty(),i instanceof RenderableSprite)c=i,c.x*=n,c.y*=-s,F(c,i,o);else if(i instanceof RenderableLine)c=i.v1,a=i.v2,c.positionScreen.x*=n,c.positionScreen.y*=-s,a.positionScreen.x*=n,a.positionScreen.y*=-s,x.setFromPoints([c.positionScreen,a.positionScreen]),!0===y.intersectsBox(x)&&O(c,a,o);else if(i instanceof RenderableFace){if(c=i.v1,a=i.v2,l=i.v3,c.positionScreen.z<-1||c.positionScreen.z>1)continue;if(a.positionScreen.z<-1||a.positionScreen.z>1)continue;if(l.positionScreen.z<-1||l.positionScreen.z>1)continue;c.positionScreen.x*=n,c.positionScreen.y*=-s,a.positionScreen.x*=n,a.positionScreen.y*=-s,l.positionScreen.x*=n,l.positionScreen.y*=-s,this.overdraw>0&&(N(c.positionScreen,a.positionScreen,this.overdraw),N(a.positionScreen,l.positionScreen,this.overdraw),N(l.positionScreen,c.positionScreen,this.overdraw)),x.setFromPoints([c.positionScreen,a.positionScreen,l.positionScreen]),!0===y.intersectsBox(x)&&W(c,a,l,i,o)}}I(),o.traverseVisible((function(e){if(e.isSVGObject){if(C.setFromMatrixPosition(e.matrixWorld),C.applyMatrix4(R),C.z<-1||C.z>1)return;const t=C.x*n,i=-C.y*s,o=e.node;o.setAttribute("transform","translate("+t+","+i+")"),G.appendChild(o)}}))}}}export{SVGObject,SVGRenderer};