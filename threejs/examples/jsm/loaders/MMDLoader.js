import{AddOperation,AnimationClip,Bone,BufferGeometry,Color,CustomBlending,TangentSpaceNormalMap,DoubleSide,DstAlphaFactor,Euler,FileLoader,Float32BufferAttribute,FrontSide,Interpolant,Loader,LoaderUtils,UniformsUtils,ShaderMaterial,MultiplyOperation,NearestFilter,NumberKeyframeTrack,OneMinusSrcAlphaFactor,Quaternion,QuaternionKeyframeTrack,RepeatWrapping,Skeleton,SkinnedMesh,SrcAlphaFactor,TextureLoader,Uint16BufferAttribute,Vector3,VectorKeyframeTrack,RGB_S3TC_DXT1_Format,RGB_PVRTC_4BPPV1_Format,RGB_PVRTC_2BPPV1_Format,RGB_ETC1_Format,RGB_ETC2_Format}from"three";import{MMDToonShader}from"../shaders/MMDToonShader.js";import{TGALoader}from"../loaders/TGALoader.js";import{MMDParser}from"../libs/mmdparser.module.js";class MMDLoader extends Loader{constructor(e){super(e),this.loader=new FileLoader(this.manager),this.parser=null,this.meshBuilder=new MeshBuilder(this.manager),this.animationBuilder=new AnimationBuilder}setAnimationPath(e){return this.animationPath=e,this}load(e,t,n,a){const r=this.meshBuilder.setCrossOrigin(this.crossOrigin);let i;i=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:LoaderUtils.extractUrlBase(e);const o=this._extractExtension(e).toLowerCase();"pmd"===o||"pmx"===o?this["pmd"===o?"loadPMD":"loadPMX"](e,(function(e){t(r.build(e,i,n,a))}),n,a):a&&a(new Error("THREE.MMDLoader: Unknown model file extension ."+o+"."))}loadAnimation(e,t,n,a,r){const i=this.animationBuilder;this.loadVMD(e,(function(e){n(t.isCamera?i.buildCameraAnimation(e):i.build(e,t))}),a,r)}loadWithAnimation(e,t,n,a,r){const i=this;this.load(e,(function(e){i.loadAnimation(t,e,(function(t){n({mesh:e,animation:t})}),a,r)}),a,r)}loadPMD(e,t,n,a){const r=this._getParser();this.loader.setMimeType(void 0).setPath(this.path).setResponseType("arraybuffer").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(e,(function(e){t(r.parsePmd(e,!0))}),n,a)}loadPMX(e,t,n,a){const r=this._getParser();this.loader.setMimeType(void 0).setPath(this.path).setResponseType("arraybuffer").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(e,(function(e){t(r.parsePmx(e,!0))}),n,a)}loadVMD(e,t,n,a){const r=Array.isArray(e)?e:[e],i=[],o=r.length,s=this._getParser();this.loader.setMimeType(void 0).setPath(this.animationPath).setResponseType("arraybuffer").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials);for(let e=0,l=r.length;e<l;e++)this.loader.load(r[e],(function(e){i.push(s.parseVmd(e,!0)),i.length===o&&t(s.mergeVmds(i))}),n,a)}loadVPD(e,t,n,a,r){const i=this._getParser();this.loader.setMimeType(t?void 0:"text/plain; charset=shift_jis").setPath(this.animationPath).setResponseType("text").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(e,(function(e){n(i.parseVpd(e,!0))}),a,r)}_extractExtension(e){const t=e.lastIndexOf(".");return t<0?"":e.slice(t+1)}_getParser(){return null===this.parser&&(this.parser=new MMDParser.Parser),this.parser}}const DEFAULT_TOON_TEXTURES=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="],NON_ALPHA_CHANNEL_FORMATS=[RGB_S3TC_DXT1_Format,RGB_PVRTC_4BPPV1_Format,RGB_PVRTC_2BPPV1_Format,RGB_ETC1_Format,RGB_ETC2_Format];class MeshBuilder{constructor(e){this.crossOrigin="anonymous",this.geometryBuilder=new GeometryBuilder,this.materialBuilder=new MaterialBuilder(e)}setCrossOrigin(e){return this.crossOrigin=e,this}build(e,t,n,a){const r=this.geometryBuilder.build(e),i=this.materialBuilder.setCrossOrigin(this.crossOrigin).setResourcePath(t).build(e,r,n,a),o=new SkinnedMesh(r,i),s=new Skeleton(initBones(o));return o.bind(s),o}}function initBones(e){const t=e.geometry,n=[];if(t&&void 0!==t.bones){for(let e=0,a=t.bones.length;e<a;e++){const a=t.bones[e],r=new Bone;n.push(r),r.name=a.name,r.position.fromArray(a.pos),r.quaternion.fromArray(a.rotq),void 0!==a.scl&&r.scale.fromArray(a.scl)}for(let a=0,r=t.bones.length;a<r;a++){const r=t.bones[a];-1!==r.parent&&null!==r.parent&&void 0!==n[r.parent]?n[r.parent].add(n[a]):e.add(n[a])}}return e.updateMatrixWorld(!0),n}class GeometryBuilder{build(e){const t=[],n=[],a=[],r=[],i=[],o=[],s=[],l=[],A=[],h=[],u=[],d=[],c=[],m=[];let p=0;const f={};for(let B=0;B<e.metadata.vertexCount;B++){const M=e.vertices[B];for(let y=0,b=M.position.length;y<b;y++)t.push(M.position[y]);for(let x=0,T=M.normal.length;x<T;x++)a.push(M.normal[x]);for(let R=0,I=M.uv.length;R<I;R++)n.push(M.uv[R]);for(let E=0;E<4;E++)s.push(M.skinIndices.length-1>=E?M.skinIndices[E]:0);for(let w=0;w<4;w++)l.push(M.skinWeights.length-1>=w?M.skinWeights[w]:0)}for(let P=0;P<e.metadata.faceCount;P++){const k=e.faces[P];for(let S=0,D=k.indices.length;S<D;S++)r.push(k.indices[S])}for(let L=0;L<e.metadata.materialCount;L++){const _=e.materials[L];i.push({offset:3*p,count:3*_.faceCount}),p+=_.faceCount}for(let N=0;N<e.metadata.rigidBodyCount;N++){const Q=e.rigidBodies[N];let O=f[Q.boneIndex];O=void 0===O?Q.type:Math.max(Q.type,O),f[Q.boneIndex]=O}for(let U=0;U<e.metadata.boneCount;U++){const v=e.bones[U],F={index:U,transformationClass:v.transformationClass,parent:v.parentIndex,name:v.name,pos:v.position.slice(0,3),rotq:[0,0,0,1],scl:[1,1,1],rigidBodyType:void 0!==f[U]?f[U]:-1};-1!==F.parent&&(F.pos[0]-=e.bones[F.parent].position[0],F.pos[1]-=e.bones[F.parent].position[1],F.pos[2]-=e.bones[F.parent].position[2]),o.push(F)}if("pmd"===e.metadata.format)for(let V=0;V<e.metadata.ikCount;V++){const G=e.iks[V],Y={target:G.target,effector:G.effector,iteration:G.iteration,maxAngle:4*G.maxAngle,links:[]};for(let z=0,K=G.links.length;z<K;z++){const H={};H.index=G.links[z].index,H.enabled=!0,e.bones[H.index].name.indexOf("ひざ")>=0&&(H.limitation=new Vector3(1,0,0)),Y.links.push(H)}u.push(Y)}else for(let W=0;W<e.metadata.boneCount;W++){const j=e.bones[W].ik;if(void 0===j)continue;const J={target:W,effector:j.effector,iteration:j.iteration,maxAngle:j.maxAngle,links:[]};for(let X=0,q=j.links.length;X<q;X++){const Z={};if(Z.index=j.links[X].index,Z.enabled=!0,1===j.links[X].angleLimitation){const $=j.links[X].lowerLimitationAngle,ee=j.links[X].upperLimitationAngle,te=-ee[0],ne=-ee[1];ee[0]=-$[0],ee[1]=-$[1],$[0]=te,$[1]=ne,Z.rotationMin=(new Vector3).fromArray($),Z.rotationMax=(new Vector3).fromArray(ee)}J.links.push(Z)}u.push(J),o[W].ik=J}if("pmx"===e.metadata.format){const ae={};for(let oe=0;oe<e.metadata.boneCount;oe++){const se=e.bones[oe],le=se.grant;if(void 0===le)continue;const Ae={index:oe,parentIndex:le.parentIndex,ratio:le.ratio,isLocal:le.isLocal,affectRotation:le.affectRotation,affectPosition:le.affectPosition,transformationClass:se.transformationClass};ae[oe]={parent:null,children:[],param:Ae,visited:!1}}const re={parent:null,children:[],param:null,visited:!1};for(const he in ae){const ue=ae[he],de=ae[ue.parentIndex]||re;ue.parent=de,de.children.push(ue)}function ie(e){e.param&&(d.push(e.param),o[e.param.index].grant=e.param),e.visited=!0;for(let t=0,n=e.children.length;t<n;t++){const n=e.children[t];n.visited||ie(n)}}ie(re)}function g(t,n,a){for(let r=0;r<n.elementCount;r++){const i=n.elements[r];let o;o="pmd"===e.metadata.format?e.morphs[0].elements[i.index].index:i.index,t.array[3*o+0]+=i.position[0]*a,t.array[3*o+1]+=i.position[1]*a,t.array[3*o+2]+=i.position[2]*a}}for(let ce=0;ce<e.metadata.morphCount;ce++){const me=e.morphs[ce],pe={name:me.name},fe=new Float32BufferAttribute(3*e.metadata.vertexCount,3);fe.name=me.name;for(let ge=0;ge<3*e.metadata.vertexCount;ge++)fe.array[ge]=t[ge];if("pmd"===e.metadata.format)0!==ce&&g(fe,me,1);else if(0===me.type)for(let Ce=0;Ce<me.elementCount;Ce++){const Be=e.morphs[me.elements[Ce].index],Me=me.elements[Ce].ratio;1===Be.type&&g(fe,Be,Me)}else 1===me.type?g(fe,me,1):2===me.type||3===me.type||4===me.type||5===me.type||6===me.type||7===me.type||me.type;A.push(pe),h.push(fe)}for(let ye=0;ye<e.metadata.rigidBodyCount;ye++){const be=e.rigidBodies[ye],xe={};for(const Te in be)xe[Te]=be[Te];if("pmx"===e.metadata.format&&-1!==xe.boneIndex){const Re=e.bones[xe.boneIndex];xe.position[0]-=Re.position[0],xe.position[1]-=Re.position[1],xe.position[2]-=Re.position[2]}c.push(xe)}for(let Ie=0;Ie<e.metadata.constraintCount;Ie++){const Ee=e.constraints[Ie],we={};for(const Se in Ee)we[Se]=Ee[Se];const Pe=c[we.rigidBodyIndex1],ke=c[we.rigidBodyIndex2];0!==Pe.type&&2===ke.type&&-1!==Pe.boneIndex&&-1!==ke.boneIndex&&e.bones[ke.boneIndex].parentIndex===Pe.boneIndex&&(ke.type=1),m.push(we)}const C=new BufferGeometry;C.setAttribute("position",new Float32BufferAttribute(t,3)),C.setAttribute("normal",new Float32BufferAttribute(a,3)),C.setAttribute("uv",new Float32BufferAttribute(n,2)),C.setAttribute("skinIndex",new Uint16BufferAttribute(s,4)),C.setAttribute("skinWeight",new Float32BufferAttribute(l,4)),C.setIndex(r);for(let De=0,Le=i.length;De<Le;De++)C.addGroup(i[De].offset,i[De].count,De);return C.bones=o,C.morphTargets=A,C.morphAttributes.position=h,C.morphTargetsRelative=!1,C.userData.MMD={bones:o,iks:u,grants:d,rigidBodies:c,constraints:m,format:e.metadata.format},C.computeBoundingSphere(),C}}class MaterialBuilder{constructor(e){this.manager=e,this.textureLoader=new TextureLoader(this.manager),this.tgaLoader=null,this.crossOrigin="anonymous",this.resourcePath=void 0}setCrossOrigin(e){return this.crossOrigin=e,this}setResourcePath(e){return this.resourcePath=e,this}build(e,t){const n=[],a={};this.textureLoader.setCrossOrigin(this.crossOrigin);for(let r=0;r<e.metadata.materialCount;r++){const i=e.materials[r],o={userData:{MMD:{}}};if(void 0!==i.name&&(o.name=i.name),o.diffuse=(new Color).fromArray(i.diffuse),o.opacity=i.diffuse[3],o.specular=(new Color).fromArray(i.specular),o.shininess=i.shininess,o.emissive=(new Color).fromArray(i.ambient),o.transparent=1!==o.opacity,o.fog=!0,o.blending=CustomBlending,o.blendSrc=SrcAlphaFactor,o.blendDst=OneMinusSrcAlphaFactor,o.blendSrcAlpha=SrcAlphaFactor,o.blendDstAlpha=DstAlphaFactor,"pmx"===e.metadata.format&&1==(1&i.flag)?o.side=DoubleSide:o.side=1===o.opacity?FrontSide:DoubleSide,"pmd"===e.metadata.format){if(i.fileName){const l=i.fileName.split("*");if(o.map=this._loadTexture(l[0],a),l.length>1){const A=l[1].slice(-4).toLowerCase();o.matcap=this._loadTexture(l[1],a),o.matcapCombine=".sph"===A?MultiplyOperation:AddOperation}}const s=-1===i.toonIndex?"toon00.bmp":e.toonTextures[i.toonIndex].fileName;o.gradientMap=this._loadTexture(s,a,{isToonTexture:!0,isDefaultToonTexture:this._isDefaultToonTexture(s)}),o.userData.outlineParameters={thickness:1===i.edgeFlag?.003:0,color:[0,0,0],alpha:1,visible:1===i.edgeFlag}}else{let h,u;-1!==i.textureIndex&&(o.map=this._loadTexture(e.textures[i.textureIndex],a),o.userData.MMD.mapFileName=e.textures[i.textureIndex]),-1===i.envTextureIndex||1!==i.envFlag&&2!=i.envFlag||(o.matcap=this._loadTexture(e.textures[i.envTextureIndex],a),o.userData.MMD.matcapFileName=e.textures[i.envTextureIndex],o.matcapCombine=1===i.envFlag?MultiplyOperation:AddOperation),-1===i.toonIndex||0!==i.toonFlag?(h="toon"+("0"+(i.toonIndex+1)).slice(-2)+".bmp",u=!0):(h=e.textures[i.toonIndex],u=!1),o.gradientMap=this._loadTexture(h,a,{isToonTexture:!0,isDefaultToonTexture:u}),o.userData.outlineParameters={thickness:i.edgeSize/300,color:i.edgeColor.slice(0,3),alpha:i.edgeColor[3],visible:0!=(16&i.flag)&&i.edgeSize>0}}void 0!==o.map&&(o.transparent||this._checkImageTransparency(o.map,t,r),o.emissive.multiplyScalar(.2)),n.push(new MMDToonMaterial(o))}if("pmx"===e.metadata.format){function d(e,t){for(let n=0,a=e.length;n<a;n++){const a=e[n];if(-1===a.index)continue;const r=t[a.index];r.opacity!==a.diffuse[3]&&(r.transparent=!0)}}for(let c=0,m=e.morphs.length;c<m;c++){const p=e.morphs[c],f=p.elements;if(0===p.type)for(let g=0,C=f.length;g<C;g++){const B=e.morphs[f[g].index];8===B.type&&d(B.elements,n)}else 8===p.type&&d(f,n)}}return n}_getTGALoader(){if(null===this.tgaLoader){if(void 0===TGALoader)throw new Error("THREE.MMDLoader: Import TGALoader");this.tgaLoader=new TGALoader(this.manager)}return this.tgaLoader}_isDefaultToonTexture(e){return 10===e.length&&/toon(10|0[0-9])\.bmp/.test(e)}_loadTexture(e,t,n,a,r){const i=this;let o;if(!0===(n=n||{}).isDefaultToonTexture){let t;try{t=parseInt(e.match(/toon([0-9]{2})\.bmp$/)[1])}catch(n){console.warn("THREE.MMDLoader: "+e+" seems like a not right default texture path. Using toon00.bmp instead."),t=0}o=DEFAULT_TOON_TEXTURES[t]}else o=this.resourcePath+e;if(void 0!==t[o])return t[o];let s=this.manager.getHandler(o);null===s&&(s=".tga"===e.slice(-4).toLowerCase()?this._getTGALoader():this.textureLoader);const l=s.load(o,(function(e){!0===n.isToonTexture&&(e.image=i._getRotatedImage(e.image),e.magFilter=NearestFilter,e.minFilter=NearestFilter),e.flipY=!1,e.wrapS=RepeatWrapping,e.wrapT=RepeatWrapping;for(let e=0;e<l.readyCallbacks.length;e++)l.readyCallbacks[e](l);delete l.readyCallbacks}),a,r);return l.readyCallbacks=[],t[o]=l,l}_getRotatedImage(e){const t=document.createElement("canvas"),n=t.getContext("2d"),a=e.width,r=e.height;return t.width=a,t.height=r,n.clearRect(0,0,a,r),n.translate(a/2,r/2),n.rotate(.5*Math.PI),n.translate(-a/2,-r/2),n.drawImage(e,0,0),n.getImageData(0,0,a,r)}_checkImageTransparency(e,t,n){e.readyCallbacks.push((function(a){function r(e,t){const n=e.width,a=e.height;let r=Math.round(t.x*n)%n,i=Math.round(t.y*a)%a;r<0&&(r+=n),i<0&&(i+=a);const o=i*n+r;return e.data[4*o+3]}if(!0===a.isCompressedTexture)return void(NON_ALPHA_CHANNEL_FORMATS.includes(a.format)?e.transparent=!1:e.transparent=!0);const i=void 0!==a.image.data?a.image:function(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const n=t.getContext("2d");return n.drawImage(e,0,0),n.getImageData(0,0,t.width,t.height)}(a.image),o=t.groups[n];(function(e,t,n){const a=e.width,i=e.height;if(e.data.length/(a*i)!=4)return!1;for(let a=0;a<n.length;a+=3){const i={x:0,y:0};for(let o=0;o<3;o++){const s=n[3*a+o],l={x:t[2*s+0],y:t[2*s+1]};if(r(e,l)<253)return!0;i.x+=l.x,i.y+=l.y}if(i.x/=3,i.y/=3,r(e,i)<253)return!0}return!1})(i,t.attributes.uv.array,t.index.array.slice(o.start,o.start+o.count))&&(e.transparent=!0)}))}}class AnimationBuilder{build(e,t){const n=this.buildSkeletalAnimation(e,t).tracks,a=this.buildMorphAnimation(e,t).tracks;for(let e=0,t=a.length;e<t;e++)n.push(a[e]);return new AnimationClip("",-1,n)}buildSkeletalAnimation(e,t){function n(e,t,n){e.push(t[n+0]/127),e.push(t[n+8]/127),e.push(t[n+4]/127),e.push(t[n+12]/127)}const a=[],r={},i=t.skeleton.bones,o={};for(let e=0,t=i.length;e<t;e++)o[i[e].name]=!0;for(let t=0;t<e.metadata.motionCount;t++){const n=e.motions[t],a=n.boneName;void 0!==o[a]&&(r[a]=r[a]||[],r[a].push(n))}for(const e in r){const i=r[e];i.sort((function(e,t){return e.frameNum-t.frameNum}));const o=[],s=[],l=[],A=[],h=[],u=t.skeleton.getBoneByName(e).position.toArray();for(let e=0,t=i.length;e<t;e++){const t=i[e].frameNum/30,a=i[e].position,r=i[e].rotation,d=i[e].interpolation;o.push(t);for(let e=0;e<3;e++)s.push(u[e]+a[e]);for(let e=0;e<4;e++)l.push(r[e]);for(let e=0;e<3;e++)n(A,d,e);n(h,d,3)}const d=".bones["+e+"]";a.push(this._createTrack(d+".position",VectorKeyframeTrack,o,s,A)),a.push(this._createTrack(d+".quaternion",QuaternionKeyframeTrack,o,l,h))}return new AnimationClip("",-1,a)}buildMorphAnimation(e,t){const n=[],a={},r=t.morphTargetDictionary;for(let t=0;t<e.metadata.morphCount;t++){const n=e.morphs[t],i=n.morphName;void 0!==r[i]&&(a[i]=a[i]||[],a[i].push(n))}for(const e in a){const t=a[e];t.sort((function(e,t){return e.frameNum-t.frameNum}));const i=[],o=[];for(let e=0,n=t.length;e<n;e++)i.push(t[e].frameNum/30),o.push(t[e].weight);n.push(new NumberKeyframeTrack(".morphTargetInfluences["+r[e]+"]",i,o))}return new AnimationClip("",-1,n)}buildCameraAnimation(e){function t(e,t){e.push(t.x),e.push(t.y),e.push(t.z)}function n(e,t,n){e.push(t[4*n+0]/127),e.push(t[4*n+1]/127),e.push(t[4*n+2]/127),e.push(t[4*n+3]/127)}const a=void 0===e.cameras?[]:e.cameras.slice();a.sort((function(e,t){return e.frameNum-t.frameNum}));const r=[],i=[],o=[],s=[],l=[],A=[],h=[],u=[],d=[],c=new Quaternion,m=new Euler,p=new Vector3,f=new Vector3;for(let e=0,B=a.length;e<B;e++){const B=a[e],M=B.frameNum/30,y=B.position,b=B.rotation,x=B.distance,T=B.fov,R=B.interpolation;r.push(M),p.set(0,0,-x),f.set(y[0],y[1],y[2]),m.set(-b[0],-b[1],-b[2]),c.setFromEuler(m),p.add(f),p.applyQuaternion(c),t(i,f),(g=o).push((C=c).x),g.push(C.y),g.push(C.z),g.push(C.w),t(s,p),l.push(T);for(let e=0;e<3;e++)n(A,R,e);n(h,R,3);for(let e=0;e<3;e++)n(u,R,4);n(d,R,5)}var g,C;const B=[];return B.push(this._createTrack("target.position",VectorKeyframeTrack,r,i,A)),B.push(this._createTrack(".quaternion",QuaternionKeyframeTrack,r,o,h)),B.push(this._createTrack(".position",VectorKeyframeTrack,r,s,u)),B.push(this._createTrack(".fov",NumberKeyframeTrack,r,l,d)),new AnimationClip("",-1,B)}_createTrack(e,t,n,a,r){if(n.length>2){n=n.slice(),a=a.slice(),r=r.slice();const e=a.length/n.length,t=r.length/n.length;let i=1;for(let o=2,s=n.length;o<s;o++){for(let t=0;t<e;t++)if(a[i*e+t]!==a[(i-1)*e+t]||a[i*e+t]!==a[o*e+t]){i++;break}if(o>i){n[i]=n[o];for(let t=0;t<e;t++)a[i*e+t]=a[o*e+t];for(let e=0;e<t;e++)r[i*t+e]=r[o*t+e]}}n.length=i+1,a.length=(i+1)*e,r.length=(i+1)*t}const i=new t(e,n,a);return i.createInterpolant=function(e){return new CubicBezierInterpolation(this.times,this.values,this.getValueSize(),e,new Float32Array(r))},i}}class CubicBezierInterpolation extends Interpolant{constructor(e,t,n,a,r){super(e,t,n,a),this.interpolationParams=r}interpolate_(e,t,n,a){const r=this.resultBuffer,i=this.sampleValues,o=this.valueSize,s=this.interpolationParams,l=e*o,A=l-o,h=a-t<.05?0:(n-t)/(a-t);if(4===o){const t=s[4*e+0],n=s[4*e+1],a=s[4*e+2],o=s[4*e+3],u=this._calculate(t,n,a,o,h);Quaternion.slerpFlat(r,0,i,A,i,l,u)}else if(3===o)for(let t=0;t!==o;++t){const n=s[12*e+4*t+0],a=s[12*e+4*t+1],o=s[12*e+4*t+2],u=s[12*e+4*t+3],d=this._calculate(n,a,o,u,h);r[t]=i[A+t]*(1-d)+i[l+t]*d}else{const t=s[4*e+0],n=s[4*e+1],a=s[4*e+2],o=s[4*e+3],u=this._calculate(t,n,a,o,h);r[0]=i[A]*(1-u)+i[l]*u}return r}_calculate(e,t,n,a,r){let i=.5,o=i,s=1-o;const l=Math;let A,h,u;for(let n=0;n<15;n++){A=3*s*s*o,h=3*s*o*o,u=o*o*o;const n=A*e+h*t+u-r;if(l.abs(n)<1e-5)break;i/=2,o+=n<0?i:-i,s=1-o}return A*n+h*a+u}}class MMDToonMaterial extends ShaderMaterial{constructor(e){super(),this.isMMDToonMaterial=!0,this.type="MMDToonMaterial",this._matcapCombine=AddOperation,this.emissiveIntensity=1,this.normalMapType=TangentSpaceNormalMap,this.combine=MultiplyOperation,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.lights=!0,this.vertexShader=MMDToonShader.vertexShader,this.fragmentShader=MMDToonShader.fragmentShader,this.defines=Object.assign({},MMDToonShader.defines),Object.defineProperty(this,"matcapCombine",{get:function(){return this._matcapCombine},set:function(e){this._matcapCombine=e,e===MultiplyOperation?(this.defines.MATCAP_BLENDING_MULTIPLY=!0,delete this.defines.MATCAP_BLENDING_ADD):(this.defines.MATCAP_BLENDING_ADD=!0,delete this.defines.MATCAP_BLENDING_MULTIPLY)}}),this.uniforms=UniformsUtils.clone(MMDToonShader.uniforms);const t=["specular","opacity","diffuse","map","matcap","gradientMap","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveMap","bumpMap","bumpScale","normalMap","normalScale","displacemantBias","displacemantMap","displacemantScale","specularMap","alphaMap","reflectivity","refractionRatio"];for(const e of t)Object.defineProperty(this,e,{get:function(){return this.uniforms[e].value},set:function(t){this.uniforms[e].value=t}});this._shininess=30,Object.defineProperty(this,"shininess",{get:function(){return this._shininess},set:function(e){this._shininess=e,this.uniforms.shininess.value=Math.max(this._shininess,1e-4)}}),Object.defineProperty(this,"color",Object.getOwnPropertyDescriptor(this,"diffuse")),this.setValues(e)}copy(e){return super.copy(e),this.matcapCombine=e.matcapCombine,this.emissiveIntensity=e.emissiveIntensity,this.normalMapType=e.normalMapType,this.combine=e.combine,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this}}export{MMDLoader};