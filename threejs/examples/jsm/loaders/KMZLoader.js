import{FileLoader,Group,Loader,LoadingManager}from"three";import{ColladaLoader}from"../loaders/ColladaLoader.js";import*as fflate from"../libs/fflate.module.js";class KMZLoader extends Loader{constructor(e){super(e)}load(e,r,o,a){const t=this,n=new FileLoader(t.manager);n.setPath(t.path),n.setResponseType("arraybuffer"),n.setRequestHeader(t.requestHeader),n.setWithCredentials(t.withCredentials),n.load(e,(function(o){try{r(t.parse(o))}catch(r){a?a(r):console.error(r),t.manager.itemError(e)}}),o,a)}parse(e){const r=new LoadingManager;r.setURLModifier((function(e){const r=function(e){for(const r in o)if(r.slice(-e.length)===e)return o[r]}(e);if(r){console.log("Loading",e);const o=new Blob([r.buffer],{type:"application/octet-stream"});return URL.createObjectURL(o)}return e}));const o=fflate.unzipSync(new Uint8Array(e));if(o["doc.kml"]){const e=(new DOMParser).parseFromString(fflate.strFromU8(o["doc.kml"]),"application/xml").querySelector("Placemark Model Link href");if(e)return new ColladaLoader(r).parse(fflate.strFromU8(o[e.textContent]))}else{console.warn("KMZLoader: Missing doc.kml file.");for(const e in o)if("dae"===e.split(".").pop().toLowerCase())return new ColladaLoader(r).parse(fflate.strFromU8(o[e]))}return console.error("KMZLoader: Couldn't find .dae file."),{scene:new Group}}}export{KMZLoader};