import{DataTextureLoader,DataUtils,FloatType,HalfFloatType,NoColorSpace,LinearFilter,LinearSRGBColorSpace,RedFormat,RGBAFormat}from"three";import*as fflate from"../libs/fflate.module.js";class EXRLoader extends DataTextureLoader{constructor(e){super(e),this.type=HalfFloatType}parse(e){const t=65536,n=14,r=65537,o=Math.pow(2.7182818,2.2),a={l:0,c:0,lc:0};function i(e,t,n,r,o){for(;n<e;)t=t<<8|F(r,o),n+=8;n-=e,a.l=t>>n&(1<<e)-1,a.c=t,a.lc=n}const l=new Array(59);function s(e){return 63&e}function c(e){return e>>6}const u={c:0,lc:0};function f(e,t,n,r){e=e<<8|F(n,r),t+=8,u.c=e,u.lc=t}const p={c:0,lc:0};function h(e,t,n,r,o,a,i,l,s){if(e==t){r<8&&(f(n,r,o,a),n=u.c,r=u.lc);let e=n>>(r-=8);if(e=new Uint8Array([e])[0],l.value+e>s)return!1;const t=i[l.value-1];for(;e-- >0;)i[l.value++]=t}else{if(!(l.value<s))return!1;i[l.value++]=e}p.c=n,p.lc=r}function w(e){return 65535&e}function d(e){const t=w(e);return t>32767?t-65536:t}const y={a:0,b:0};function v(e,t){const n=d(e),r=d(t),o=n+(1&r)+(r>>1),a=o,i=o-r;y.a=a,y.b=i}function S(e,t){const n=w(e),r=w(t),o=n-(r>>1)&65535,a=r+o-32768&65535;y.a=a,y.b=o}function m(e,t,n,r,o,a,i){const l=i<16384,s=n>o?o:n;let c,u,f=1;for(;f<=s;)f<<=1;for(f>>=1,c=f,f>>=1;f>=1;){u=0;const i=u+a*(o-c),s=a*f,p=a*c,h=r*f,w=r*c;let d,m,b,g;for(;u<=i;u+=p){let o=u;const a=u+r*(n-c);for(;o<=a;o+=w){const n=o+h,r=o+s,a=r+h;l?(v(e[o+t],e[r+t]),d=y.a,b=y.b,v(e[n+t],e[a+t]),m=y.a,g=y.b,v(d,m),e[o+t]=y.a,e[n+t]=y.b,v(b,g),e[r+t]=y.a,e[a+t]=y.b):(S(e[o+t],e[r+t]),d=y.a,b=y.b,S(e[n+t],e[a+t]),m=y.a,g=y.b,S(d,m),e[o+t]=y.a,e[n+t]=y.b,S(b,g),e[r+t]=y.a,e[a+t]=y.b)}if(n&f){const n=o+s;l?v(e[o+t],e[n+t]):S(e[o+t],e[n+t]),d=y.a,e[n+t]=y.b,e[o+t]=d}}if(o&f){let o=u;const a=u+r*(n-c);for(;o<=a;o+=w){const n=o+h;l?v(e[o+t],e[n+t]):S(e[o+t],e[n+t]),d=y.a,e[n+t]=y.b,e[o+t]=d}}c=f,f>>=1}return u}function b(e,t,o,w,d,y){const v=o.value,S=D(t,o),m=D(t,o);o.value+=4;const b=D(t,o);if(o.value+=4,S<0||S>=r||m<0||m>=r)throw new Error("Something wrong with HUF_ENCSIZE");const g=new Array(r),A=new Array(16384);if(function(e){for(let t=0;t<16384;t++)e[t]={},e[t].len=0,e[t].lit=0,e[t].p=null}(A),function(e,t,n,o,s,c){const u=t;let f=0,p=0;for(;o<=s;o++){if(u.value-t.value>n)return!1;i(6,f,p,e,u);const r=a.l;if(f=a.c,p=a.lc,c[o]=r,63==r){if(u.value-t.value>n)throw new Error("Something wrong with hufUnpackEncTable");i(8,f,p,e,u);let r=a.l+6;if(f=a.c,p=a.lc,o+r>s+1)throw new Error("Something wrong with hufUnpackEncTable");for(;r--;)c[o++]=0;o--}else if(r>=59){let e=r-59+2;if(o+e>s+1)throw new Error("Something wrong with hufUnpackEncTable");for(;e--;)c[o++]=0;o--}}!function(e){for(let e=0;e<=58;++e)l[e]=0;for(let t=0;t<r;++t)l[e[t]]+=1;let t=0;for(let e=58;e>0;--e){const n=t+l[e]>>1;l[e]=t,t=n}for(let t=0;t<r;++t){const n=e[t];n>0&&(e[t]=n|l[n]++<<6)}}(c)}(e,o,w-(o.value-v),S,m,g),b>8*(w-(o.value-v)))throw new Error("Something wrong with hufUncompress");!function(e,t,r,o){for(;t<=r;t++){const r=c(e[t]),a=s(e[t]);if(r>>a)throw new Error("Invalid table entry");if(a>n){const e=o[r>>a-n];if(e.len)throw new Error("Invalid table entry");if(e.lit++,e.p){const t=e.p;e.p=new Array(e.lit);for(let n=0;n<e.lit-1;++n)e.p[n]=t[n]}else e.p=new Array(1);e.p[e.lit-1]=t}else if(a){let e=0;for(let i=1<<n-a;i>0;i--){const i=o[(r<<n-a)+e];if(i.len||i.p)throw new Error("Invalid table entry");i.len=a,i.lit=t,e++}}}}(g,S,m,A),function(e,t,r,o,a,i,l,w,d){let y=0,v=0;const S=l,m=Math.trunc(o.value+(a+7)/8);for(;o.value<m;)for(f(y,v,r,o),y=u.c,v=u.lc;v>=n;){const a=t[y>>v-n&16383];if(a.len)v-=a.len,h(a.lit,i,y,v,r,o,w,d,S),y=p.c,v=p.lc;else{if(!a.p)throw new Error("hufDecode issues");let t;for(t=0;t<a.lit;t++){const n=s(e[a.p[t]]);for(;v<n&&o.value<m;)f(y,v,r,o),y=u.c,v=u.lc;if(v>=n&&c(e[a.p[t]])==(y>>v-n&(1<<n)-1)){v-=n,h(a.p[t],i,y,v,r,o,w,d,S),y=p.c,v=p.lc;break}}if(t==a.lit)throw new Error("hufDecode issues")}}const b=8-a&7;for(y>>=b,v-=b;v>0;){const e=t[y<<n-v&16383];if(!e.len)throw new Error("hufDecode issues");v-=e.len,h(e.lit,i,y,v,r,o,w,d,S),y=p.c,v=p.lc}}(g,A,e,o,b,m,y,d,{value:0})}function g(e){for(let t=1;t<e.length;t++){const n=e[t-1]+e[t]-128;e[t]=n}}function A(e,t){let n=0,r=Math.floor((e.length+1)/2),o=0;const a=e.length-1;for(;!(o>a||(t[o++]=e[n++],o>a));)t[o++]=e[r++]}function E(e){let t=e.byteLength;const n=new Array;let r=0;const o=new DataView(e);for(;t>0;){const e=o.getInt8(r++);if(e<0){const a=-e;t-=a+1;for(let e=0;e<a;e++)n.push(o.getUint8(r++))}else{const a=e;t-=2;const i=o.getUint8(r++);for(let e=0;e<a+1;e++)n.push(i)}}return n}function U(e,t,n){let r,o=1;for(;o<64;)r=t[e.value],65280==r?o=64:r>>8==255?o+=255&r:(n[o]=r,o++),e.value++}function C(e){const t=.5*Math.cos(.7853975),n=.5*Math.cos(3.14159/16),r=.5*Math.cos(3.14159/8),o=.5*Math.cos(3*3.14159/16),a=.5*Math.cos(.981746875),i=.5*Math.cos(3*3.14159/8),l=.5*Math.cos(1.374445625),s=new Array(4),c=new Array(4),u=new Array(4),f=new Array(4);for(let p=0;p<8;++p){const h=8*p;s[0]=r*e[h+2],s[1]=i*e[h+2],s[2]=r*e[h+6],s[3]=i*e[h+6],c[0]=n*e[h+1]+o*e[h+3]+a*e[h+5]+l*e[h+7],c[1]=o*e[h+1]-l*e[h+3]-n*e[h+5]-a*e[h+7],c[2]=a*e[h+1]-n*e[h+3]+l*e[h+5]+o*e[h+7],c[3]=l*e[h+1]-a*e[h+3]+o*e[h+5]-n*e[h+7],u[0]=t*(e[h+0]+e[h+4]),u[3]=t*(e[h+0]-e[h+4]),u[1]=s[0]+s[3],u[2]=s[1]-s[2],f[0]=u[0]+u[1],f[1]=u[3]+u[2],f[2]=u[3]-u[2],f[3]=u[0]-u[1],e[h+0]=f[0]+c[0],e[h+1]=f[1]+c[1],e[h+2]=f[2]+c[2],e[h+3]=f[3]+c[3],e[h+4]=f[3]-c[3],e[h+5]=f[2]-c[2],e[h+6]=f[1]-c[1],e[h+7]=f[0]-c[0]}for(let p=0;p<8;++p)s[0]=r*e[16+p],s[1]=i*e[16+p],s[2]=r*e[48+p],s[3]=i*e[48+p],c[0]=n*e[8+p]+o*e[24+p]+a*e[40+p]+l*e[56+p],c[1]=o*e[8+p]-l*e[24+p]-n*e[40+p]-a*e[56+p],c[2]=a*e[8+p]-n*e[24+p]+l*e[40+p]+o*e[56+p],c[3]=l*e[8+p]-a*e[24+p]+o*e[40+p]-n*e[56+p],u[0]=t*(e[p]+e[32+p]),u[3]=t*(e[p]-e[32+p]),u[1]=s[0]+s[3],u[2]=s[1]-s[2],f[0]=u[0]+u[1],f[1]=u[3]+u[2],f[2]=u[3]-u[2],f[3]=u[0]-u[1],e[0+p]=f[0]+c[0],e[8+p]=f[1]+c[1],e[16+p]=f[2]+c[2],e[24+p]=f[3]+c[3],e[32+p]=f[3]-c[3],e[40+p]=f[2]-c[2],e[48+p]=f[1]-c[1],e[56+p]=f[0]-c[0]}function M(e){for(let t=0;t<64;++t){const n=e[0][t],r=e[1][t],o=e[2][t];e[0][t]=n+1.5747*o,e[1][t]=n-.1873*r-.4682*o,e[2][t]=n+1.8556*r}}function z(e,t,n){for(let a=0;a<64;++a)t[n+a]=DataUtils.toHalfFloat((r=e[a])<=1?Math.sign(r)*Math.pow(Math.abs(r),2.2):Math.sign(r)*Math.pow(o,Math.abs(r)-1));var r}function R(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function O(e){const t=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),n=new Uint8Array(E(t)),r=new Uint8Array(n.length);return g(n),A(n,r),new DataView(r.buffer)}function I(e){const t=e.array.slice(e.offset.value,e.offset.value+e.size),n=fflate.unzlibSync(t),r=new Uint8Array(n.length);return g(n),A(n,r),new DataView(r.buffer)}function x(e){const n=e.viewer,r={value:e.offset.value},o=new Uint16Array(e.width*e.scanlineBlockSize*(e.channels*e.type)),a=new Uint8Array(8192);let i=0;const l=new Array(e.channels);for(let t=0;t<e.channels;t++)l[t]={},l[t].start=i,l[t].end=l[t].start,l[t].nx=e.width,l[t].ny=e.lines,l[t].size=e.type,i+=l[t].nx*l[t].ny*l[t].size;const s=V(n,r),c=V(n,r);if(c>=8192)throw new Error("Something is wrong with PIZ_COMPRESSION BITMAP_SIZE");if(s<=c)for(let e=0;e<c-s+1;e++)a[e+s]=T(n,r);const u=new Uint16Array(t),f=function(e,n){let r=0;for(let o=0;o<t;++o)(0==o||e[o>>3]&1<<(7&o))&&(n[r++]=o);const o=r-1;for(;r<t;)n[r++]=0;return o}(a,u),p=D(n,r);b(e.array,n,r,p,o,i);for(let t=0;t<e.channels;++t){const e=l[t];for(let n=0;n<l[t].size;++n)m(o,e.start+n,e.nx,e.size,e.ny,e.nx*e.size,f)}!function(e,t,n){for(let r=0;r<n;++r)t[r]=e[t[r]]}(u,o,i);let h=0;const w=new Uint8Array(o.buffer.byteLength);for(let t=0;t<e.lines;t++)for(let t=0;t<e.channels;t++){const e=l[t],n=e.nx*e.size,r=new Uint8Array(o.buffer,2*e.end,2*n);w.set(r,h),h+=2*n,e.end+=n}return new DataView(w.buffer)}function k(e){const t=e.array.slice(e.offset.value,e.offset.value+e.size),n=fflate.unzlibSync(t),r=e.lines*e.channels*e.width,o=1==e.type?new Uint16Array(r):new Uint32Array(r);let a=0,i=0;const l=new Array(4);for(let t=0;t<e.lines;t++)for(let t=0;t<e.channels;t++){let t=0;switch(e.type){case 1:l[0]=a,l[1]=l[0]+e.width,a=l[1]+e.width;for(let r=0;r<e.width;++r)t+=n[l[0]++]<<8|n[l[1]++],o[i]=t,i++;break;case 2:l[0]=a,l[1]=l[0]+e.width,l[2]=l[1]+e.width,a=l[2]+e.width;for(let r=0;r<e.width;++r)t+=n[l[0]++]<<24|n[l[1]++]<<16|n[l[2]++]<<8,o[i]=t,i++}}return new DataView(o.buffer)}function P(e){const t=e.viewer,n={value:e.offset.value},r=new Uint8Array(e.width*e.lines*(e.channels*e.type*2)),o={version:_(t,n),unknownUncompressedSize:_(t,n),unknownCompressedSize:_(t,n),acCompressedSize:_(t,n),dcCompressedSize:_(t,n),rleCompressedSize:_(t,n),rleUncompressedSize:_(t,n),rleRawSize:_(t,n),totalAcUncompressedCount:_(t,n),totalDcUncompressedCount:_(t,n),acCompression:_(t,n)};if(o.version<2)throw new Error("EXRLoader.parse: "+$.compression+" version "+o.version+" is unsupported");const a=new Array;let i=V(t,n)-2;for(;i>0;){const e=N(t.buffer,n),r=T(t,n),o=r>>2&3,l=new Int8Array([(r>>4)-1])[0],s=T(t,n);a.push({name:e,index:l,type:s,compression:o}),i-=e.length+3}const l=$.channels,s=new Array(e.channels);for(let t=0;t<e.channels;++t){const n=s[t]={},r=l[t];n.name=r.name,n.compression=0,n.decoded=!1,n.type=r.pixelType,n.pLinear=r.pLinear,n.width=e.width,n.height=e.lines}const c={idx:new Array(3)};for(let t=0;t<e.channels;++t){const e=s[t];for(let n=0;n<a.length;++n){const r=a[n];e.name==r.name&&(e.compression=r.compression,r.index>=0&&(c.idx[r.index]=t),e.offset=t)}}let u,f,p;if(o.acCompressedSize>0)switch(o.acCompression){case 0:u=new Uint16Array(o.totalAcUncompressedCount),b(e.array,t,n,o.acCompressedSize,u,o.totalAcUncompressedCount);break;case 1:const r=e.array.slice(n.value,n.value+o.totalAcUncompressedCount),a=fflate.unzlibSync(r);u=new Uint16Array(a.buffer),n.value+=o.totalAcUncompressedCount}if(o.dcCompressedSize>0){const t={array:e.array,offset:n,size:o.dcCompressedSize};f=new Uint16Array(I(t).buffer),n.value+=o.dcCompressedSize}if(o.rleRawSize>0){const t=e.array.slice(n.value,n.value+o.rleCompressedSize);p=E(fflate.unzlibSync(t).buffer),n.value+=o.rleCompressedSize}let h=0;const w=new Array(s.length);for(let e=0;e<w.length;++e)w[e]=new Array;for(let t=0;t<e.lines;++t)for(let t=0;t<s.length;++t)w[t].push(h),h+=s[t].width*e.type*2;!function(e,t,n,r,o,a){let i=new DataView(a.buffer);const l=n[e.idx[0]].width,s=n[e.idx[0]].height,c=Math.floor(l/8),u=Math.ceil(l/8),f=Math.ceil(s/8),p=l-8*(u-1),h=s-8*(f-1),w={value:0},d=new Array(3),y=new Array(3),v=new Array(3),S=new Array(3),m=new Array(3);for(let n=0;n<3;++n)m[n]=t[e.idx[n]],d[n]=n<1?0:d[n-1]+u*f,y[n]=new Float32Array(64),v[n]=new Uint16Array(64),S[n]=new Uint16Array(64*u);for(let t=0;t<f;++t){let a=8;t==f-1&&(a=h);let l=8;for(let e=0;e<u;++e){e==u-1&&(l=p);for(let e=0;e<3;++e)v[e].fill(0),v[e][0]=o[d[e]++],U(w,r,v[e]),b=v[e],(g=y[e])[0]=H(b[0]),g[1]=H(b[1]),g[2]=H(b[5]),g[3]=H(b[6]),g[4]=H(b[14]),g[5]=H(b[15]),g[6]=H(b[27]),g[7]=H(b[28]),g[8]=H(b[2]),g[9]=H(b[4]),g[10]=H(b[7]),g[11]=H(b[13]),g[12]=H(b[16]),g[13]=H(b[26]),g[14]=H(b[29]),g[15]=H(b[42]),g[16]=H(b[3]),g[17]=H(b[8]),g[18]=H(b[12]),g[19]=H(b[17]),g[20]=H(b[25]),g[21]=H(b[30]),g[22]=H(b[41]),g[23]=H(b[43]),g[24]=H(b[9]),g[25]=H(b[11]),g[26]=H(b[18]),g[27]=H(b[24]),g[28]=H(b[31]),g[29]=H(b[40]),g[30]=H(b[44]),g[31]=H(b[53]),g[32]=H(b[10]),g[33]=H(b[19]),g[34]=H(b[23]),g[35]=H(b[32]),g[36]=H(b[39]),g[37]=H(b[45]),g[38]=H(b[52]),g[39]=H(b[54]),g[40]=H(b[20]),g[41]=H(b[22]),g[42]=H(b[33]),g[43]=H(b[38]),g[44]=H(b[46]),g[45]=H(b[51]),g[46]=H(b[55]),g[47]=H(b[60]),g[48]=H(b[21]),g[49]=H(b[34]),g[50]=H(b[37]),g[51]=H(b[47]),g[52]=H(b[50]),g[53]=H(b[56]),g[54]=H(b[59]),g[55]=H(b[61]),g[56]=H(b[35]),g[57]=H(b[36]),g[58]=H(b[48]),g[59]=H(b[49]),g[60]=H(b[57]),g[61]=H(b[58]),g[62]=H(b[62]),g[63]=H(b[63]),C(y[e]);M(y);for(let t=0;t<3;++t)z(y[t],S[t],64*e)}let s=0;for(let r=0;r<3;++r){const o=n[e.idx[r]].type;for(let e=8*t;e<8*t+a;++e){s=m[r][e];for(let t=0;t<c;++t){const n=64*t+8*(7&e);i.setUint16(s+0*o,S[r][n+0],!0),i.setUint16(s+2*o,S[r][n+1],!0),i.setUint16(s+4*o,S[r][n+2],!0),i.setUint16(s+6*o,S[r][n+3],!0),i.setUint16(s+8*o,S[r][n+4],!0),i.setUint16(s+10*o,S[r][n+5],!0),i.setUint16(s+12*o,S[r][n+6],!0),i.setUint16(s+14*o,S[r][n+7],!0),s+=16*o}}if(c!=u)for(let e=8*t;e<8*t+a;++e){const t=m[r][e]+8*c*2*o,n=64*c+8*(7&e);for(let e=0;e<l;++e)i.setUint16(t+2*e*o,S[r][n+e],!0)}}}var b,g;const A=new Uint16Array(l);i=new DataView(a.buffer);for(let t=0;t<3;++t){n[e.idx[t]].decoded=!0;const r=n[e.idx[t]].type;if(2==n[t].type)for(let e=0;e<s;++e){const n=m[t][e];for(let e=0;e<l;++e)A[e]=i.getUint16(n+2*e*r,!0);for(let e=0;e<l;++e)i.setFloat32(n+2*e*r,H(A[e]),!0)}}}(c,w,s,u,f,r);for(let t=0;t<s.length;++t){const n=s[t];if(!n.decoded){if(2!==n.compression)throw new Error("EXRLoader.parse: unsupported channel compression");{let o=0,a=0;for(let i=0;i<e.lines;++i){let e=w[t][o];for(let t=0;t<n.width;++t){for(let t=0;t<2*n.type;++t)r[e++]=p[a+t*n.width*n.height];a++}o++}}}}return new DataView(r.buffer)}function N(e,t){const n=new Uint8Array(e);let r=0;for(;0!=n[t.value+r];)r+=1;const o=(new TextDecoder).decode(n.slice(t.value,t.value+r));return t.value=t.value+r+1,o}function L(e,t){const n=e.getInt32(t.value,!0);return t.value=t.value+4,n}function D(e,t){const n=e.getUint32(t.value,!0);return t.value=t.value+4,n}function F(e,t){const n=e[t.value];return t.value=t.value+1,n}function T(e,t){const n=e.getUint8(t.value);return t.value=t.value+1,n}const _=function(e,t){let n;return n="getBigInt64"in DataView.prototype?Number(e.getBigInt64(t.value,!0)):e.getUint32(t.value+4,!0)+Number(e.getUint32(t.value,!0)<<32),t.value+=8,n};function B(e,t){const n=e.getFloat32(t.value,!0);return t.value+=4,n}function X(e,t){return DataUtils.toHalfFloat(B(e,t))}function H(e){const t=(31744&e)>>10,n=1023&e;return(e>>15?-1:1)*(t?31===t?n?NaN:1/0:Math.pow(2,t-15)*(1+n/1024):n/1024*6103515625e-14)}function V(e,t){const n=e.getUint16(t.value,!0);return t.value+=2,n}function W(e,t){return H(V(e,t))}function Z(e,t,n,r,o){return"string"===r||"stringvector"===r||"iccProfile"===r?function(e,t,n){const r=(new TextDecoder).decode(new Uint8Array(e).slice(t.value,t.value+n));return t.value=t.value+n,r}(t,n,o):"chlist"===r?function(e,t,n,r){const o=n.value,a=[];for(;n.value<o+r-1;){const r=N(t,n),o=L(e,n),i=T(e,n);n.value+=3;const l=L(e,n),s=L(e,n);a.push({name:r,pixelType:o,pLinear:i,xSampling:l,ySampling:s})}return n.value+=1,a}(e,t,n,o):"chromaticities"===r?function(e,t){return{redX:B(e,t),redY:B(e,t),greenX:B(e,t),greenY:B(e,t),blueX:B(e,t),blueY:B(e,t),whiteX:B(e,t),whiteY:B(e,t)}}(e,n):"compression"===r?function(e,t){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][T(e,t)]}(e,n):"box2i"===r?function(e,t){return{xMin:D(e,t),yMin:D(e,t),xMax:D(e,t),yMax:D(e,t)}}(e,n):"lineOrder"===r?function(e,t){return["INCREASING_Y"][T(e,t)]}(e,n):"float"===r?B(e,n):"v2f"===r?function(e,t){return[B(e,t),B(e,t)]}(e,n):"v3f"===r?function(e,t){return[B(e,t),B(e,t),B(e,t)]}(e,n):"int"===r?L(e,n):"rational"===r?function(e,t){return[L(e,t),D(e,t)]}(e,n):"timecode"===r?function(e,t){return[D(e,t),D(e,t)]}(e,n):"preview"===r?(n.value+=o,"skipped"):void(n.value+=o)}const G=new DataView(e),Y=new Uint8Array(e),j={value:0},$=function(e,t,n){const r={};if(20000630!=e.getUint32(0,!0))throw new Error("THREE.EXRLoader: provided file doesn't appear to be in OpenEXR format.");r.version=e.getUint8(4);const o=e.getUint8(5);r.spec={singleTile:!!(2&o),longName:!!(4&o),deepFormat:!!(8&o),multiPart:!!(16&o)},n.value=8;let a=!0;for(;a;){const o=N(t,n);if(0==o)a=!1;else{const a=N(t,n),i=Z(e,t,n,a,D(e,n));void 0===i?console.warn(`EXRLoader.parse: skipped unknown header attribute type '${a}'.`):r[o]=i}}if(0!=(-5&o))throw console.error("EXRHeader:",r),new Error("THREE.EXRLoader: provided file is currently unsupported.");return r}(G,e,j),q=function(e,t,n,r,o){const a={size:0,viewer:t,array:n,offset:r,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,channels:e.channels.length,bytesPerLine:null,lines:null,inputSize:null,type:e.channels[0].pixelType,uncompress:null,getter:null,format:null,colorSpace:LinearSRGBColorSpace};switch(e.compression){case"NO_COMPRESSION":a.lines=1,a.uncompress=R;break;case"RLE_COMPRESSION":a.lines=1,a.uncompress=O;break;case"ZIPS_COMPRESSION":a.lines=1,a.uncompress=I;break;case"ZIP_COMPRESSION":a.lines=16,a.uncompress=I;break;case"PIZ_COMPRESSION":a.lines=32,a.uncompress=x;break;case"PXR24_COMPRESSION":a.lines=16,a.uncompress=k;break;case"DWAA_COMPRESSION":a.lines=32,a.uncompress=P;break;case"DWAB_COMPRESSION":a.lines=256,a.uncompress=P;break;default:throw new Error("EXRLoader.parse: "+e.compression+" is unsupported")}if(a.scanlineBlockSize=a.lines,1==a.type)switch(o){case FloatType:a.getter=W,a.inputSize=2;break;case HalfFloatType:a.getter=V,a.inputSize=2}else{if(2!=a.type)throw new Error("EXRLoader.parse: unsupported pixelType "+a.type+" for "+e.compression+".");switch(o){case FloatType:a.getter=B,a.inputSize=4;break;case HalfFloatType:a.getter=X,a.inputSize=4}}a.blockCount=(e.dataWindow.yMax+1)/a.scanlineBlockSize;for(let e=0;e<a.blockCount;e++)_(t,r);a.outputChannels=3==a.channels?4:a.channels;const i=a.width*a.height*a.outputChannels;switch(o){case FloatType:a.byteArray=new Float32Array(i),a.channels<a.outputChannels&&a.byteArray.fill(1,0,i);break;case HalfFloatType:a.byteArray=new Uint16Array(i),a.channels<a.outputChannels&&a.byteArray.fill(15360,0,i);break;default:console.error("THREE.EXRLoader: unsupported type: ",o)}return a.bytesPerLine=a.width*a.inputSize*a.channels,4==a.outputChannels?(a.format=RGBAFormat,a.colorSpace=LinearSRGBColorSpace):(a.format=RedFormat,a.colorSpace=NoColorSpace),a}($,G,Y,j,this.type),J={value:0},K={R:0,G:1,B:2,A:3,Y:0};for(let e=0;e<q.height/q.scanlineBlockSize;e++){const t=D(G,j);q.size=D(G,j),q.lines=t+q.scanlineBlockSize>q.height?q.height-t:q.scanlineBlockSize;const n=q.size<q.lines*q.bytesPerLine?q.uncompress(q):R(q);j.value+=q.size;for(let t=0;t<q.scanlineBlockSize;t++){const r=t+e*q.scanlineBlockSize;if(r>=q.height)break;for(let e=0;e<q.channels;e++){const o=K[$.channels[e].name];for(let a=0;a<q.width;a++){J.value=(t*(q.channels*q.width)+e*q.width+a)*q.inputSize;const i=(q.height-1-r)*(q.width*q.outputChannels)+a*q.outputChannels+o;q.byteArray[i]=q.getter(n,J)}}}}return{header:$,width:q.width,height:q.height,data:q.byteArray,format:q.format,colorSpace:q.colorSpace,type:this.type}}setDataType(e){return this.type=e,this}load(e,t,n,r){return super.load(e,(function(e,n){e.colorSpace=n.colorSpace,e.minFilter=LinearFilter,e.magFilter=LinearFilter,e.generateMipmaps=!1,e.flipY=!1,t&&t(e,n)}),n,r)}}export{EXRLoader};