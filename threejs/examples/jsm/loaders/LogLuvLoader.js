import{DataUtils,DataTextureLoader,FloatType,HalfFloatType,RGBAFormat}from"three";class LogLuvLoader extends DataTextureLoader{constructor(t){super(t),this.type=HalfFloatType}parse(t){const r=UTIF.decode(t);UTIF.decodeImage(t,r[0]);const e=UTIF.toRGBA(r[0],this.type);return{width:r[0].width,height:r[0].height,data:e,format:RGBAFormat,type:this.type,flipY:!0}}setDataType(t){return this.type=t,this}}const UTIF={decode:function(t,r){null==r&&(r={parseMN:!0,debug:!1});var e=new Uint8Array(t),n=0,i=UTIF._binBE.readASCII(e,n,2);n+=2;var a="II"==i?UTIF._binLE:UTIF._binBE;a.readUshort(e,n),n+=2;for(var o=a.readUint(e,n),f=[];;){var u=a.readUshort(e,o),l=a.readUshort(e,o+4);if(0!=u&&(l<1||13<l)){console.log("error in TIFF");break}if(UTIF._readIFD(a,e,o,f,0,r),0==(o=a.readUint(e,o+2+12*u)))break}return f},decodeImage:function(t,r,e){if(!r.data){var n=new Uint8Array(t),i=UTIF._binBE.readASCII(n,0,2);if(null!=r.t256){r.isLE="II"==i,r.width=r.t256[0],r.height=r.t257[0];var a,o=r.t259?r.t259[0]:1,f=r.t266?r.t266[0]:1;r.t284&&2==r.t284[0]&&console.log("PlanarConfiguration 2 should not be used!"),7==o&&r.t258&&r.t258.length>3&&(r.t258=r.t258.slice(0,3)),a=r.t258?Math.min(32,r.t258[0])*r.t258.length:r.t277?r.t277[0]:1,1==o&&null!=r.t279&&r.t278&&32803==r.t262[0]&&(a=Math.round(8*r.t279[0]/(r.width*r.t278[0])));var u=8*Math.ceil(r.width*a/8),l=r.t273;null==l&&(l=r.t324);var U=r.t279;1==o&&1==l.length&&(U=[r.height*(u>>>3)]),null==U&&(U=r.t325);var I=new Uint8Array(r.height*(u>>>3)),d=0;if(null!=r.t322){for(var h=r.t322[0],F=r.t323[0],s=Math.floor((r.width+h-1)/h),c=Math.floor((r.height+F-1)/F),T=new Uint8Array(0|Math.ceil(h*F*a/8)),b=0;b<c;b++)for(var v=0;v<s;v++){for(var _=b*s+v,g=0;g<T.length;g++)T[g]=0;UTIF.decode._decompress(r,e,n,l[_],U[_],o,T,0,f),6==o?I=T:UTIF._copyTile(T,0|Math.ceil(h*a/8),F,I,0|Math.ceil(r.width*a/8),r.height,0|Math.ceil(v*h*a/8),b*F)}d=8*I.length}else{var p=r.t278?r.t278[0]:r.height;for(p=Math.min(p,r.height),_=0;_<l.length;_++)UTIF.decode._decompress(r,e,n,l[_],U[_],o,I,0|Math.ceil(d/8),f),d+=u*p;d=Math.min(d,8*I.length)}r.data=new Uint8Array(I.buffer,0,0|Math.ceil(d/8))}}}};UTIF.decode._decompress=function(t,r,e,n,i,a,o,f){34676==a?UTIF.decode._decodeLogLuv32(t,e,n,i,o,f):console.log("Unsupported compression",a);var u=t.t258?Math.min(32,t.t258[0]):1,l=t.t277?t.t277[0]:1,U=u*l>>>3,I=t.t278?t.t278[0]:t.height,d=Math.ceil(u*l*t.width/8);if(16==u&&!t.isLE&&null==t.t33422)for(var h=0;h<I;h++)for(var F=f+h*d,s=1;s<d;s+=2){var c=o[F+s];o[F+s]=o[F+s-1],o[F+s-1]=c}if(t.t317&&2==t.t317[0])for(h=0;h<I;h++){var T=f+h*d;if(16==u)for(var b=U;b<d;b+=2){var v=(o[T+b+1]<<8|o[T+b])+(o[T+b-U+1]<<8|o[T+b-U]);o[T+b]=255&v,o[T+b+1]=v>>>8&255}else if(3==l)for(b=3;b<d;b+=3)o[T+b]=o[T+b]+o[T+b-3]&255,o[T+b+1]=o[T+b+1]+o[T+b-2]&255,o[T+b+2]=o[T+b+2]+o[T+b-1]&255;else for(b=U;b<d;b++)o[T+b]=o[T+b]+o[T+b-U]&255}},UTIF.decode._decodeLogLuv32=function(t,r,e,n,i,a){for(var o=t.width,f=4*o,u=0,l=new Uint8Array(f);u<n;){for(var U=0;U<f;){var I=r[e+u];if(u++,I<128){for(var d=0;d<I;d++)l[U+d]=r[e+u+d];U+=I,u+=I}else{for(I-=126,d=0;d<I;d++)l[U+d]=r[e+u];U+=I,u++}}for(var h=0;h<o;h++)i[a+0]=l[h],i[a+1]=l[h+o],i[a+2]=l[h+2*o],i[a+4]=l[h+3*o],a+=6}},UTIF.tags={},UTIF._types=function(){var t=new Array(250);return t.fill(0),{basic:{main:t=t.concat([0,0,0,0,4,3,3,3,3,3,0,0,3,0,0,0,3,0,0,2,2,2,2,4,3,0,0,3,4,4,3,3,5,5,3,2,5,5,0,0,0,0,4,4,0,0,3,3,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,2,2,3,5,5,3,0,3,3,4,4,4,3,4,0,0,0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),rest:{33432:2,33434:5,33437:5,34665:4,34850:3,34853:4,34855:3,34864:3,34866:4,36864:7,36867:2,36868:2,37121:7,37377:10,37378:5,37380:10,37381:5,37383:3,37384:3,37385:3,37386:5,37510:7,37520:2,37521:2,37522:2,40960:7,40961:3,40962:4,40963:4,40965:4,41486:5,41487:5,41488:3,41985:3,41986:3,41987:3,41988:5,41989:3,41990:3,41993:3,41994:3,41995:7,41996:3,42032:2,42033:2,42034:5,42036:2,42037:2,59932:7}},gps:{main:[1,2,5,2,5,1,5,5,0,9],rest:{18:2,29:2}}}}(),UTIF._readIFD=function(t,r,e,n,i,a){var o=t.readUshort(r,e);e+=2;var f={};a.debug&&console.log("   ".repeat(i),n.length-1,">>>----------------");for(var u=0;u<o;u++){var l=t.readUshort(r,e);e+=2;var U=t.readUshort(r,e);e+=2;var I=t.readUint(r,e);e+=4;var d=t.readUint(r,e);e+=4;var h=[];if(1!=U&&7!=U||(h=new Uint8Array(r.buffer,I<5?e-4:d,I)),2==U){var F=I<5?e-4:d,s=r[F],c=Math.max(0,Math.min(I-1,r.length-F));s<128||0==c?h.push(t.readASCII(r,F,c)):h=new Uint8Array(r.buffer,F,c)}if(3==U)for(var T=0;T<I;T++)h.push(t.readUshort(r,(I<3?e-4:d)+2*T));if(4==U||13==U)for(T=0;T<I;T++)h.push(t.readUint(r,(I<2?e-4:d)+4*T));if(5==U||10==U){var b=5==U?t.readUint:t.readInt;for(T=0;T<I;T++)h.push([b(r,d+8*T),b(r,d+8*T+4)])}if(8==U)for(T=0;T<I;T++)h.push(t.readShort(r,(I<3?e-4:d)+2*T));if(9==U)for(T=0;T<I;T++)h.push(t.readInt(r,(I<2?e-4:d)+4*T));if(11==U)for(T=0;T<I;T++)h.push(t.readFloat(r,d+4*T));if(12==U)for(T=0;T<I;T++)h.push(t.readDouble(r,d+8*T));if(0==I||0!=h.length){if(a.debug&&console.log("   ".repeat(i),l,U,UTIF.tags[l],h),f["t"+l]=h,330==l||34665==l||34853==l||50740==l&&t.readUshort(r,t.readUint(h,0))<300||61440==l){var v=50740==l?[t.readUint(h,0)]:h,_=[];for(T=0;T<v.length;T++)UTIF._readIFD(t,r,v[T],_,i+1,a);330==l&&(f.subIFD=_),34665==l&&(f.exifIFD=_[0]),34853==l&&(f.gpsiIFD=_[0]),50740==l&&(f.dngPrvt=_[0]),61440==l&&(f.fujiIFD=_[0])}if(37500==l&&a.parseMN){var g=h;if("Nikon"==t.readASCII(g,0,5))f.makerNote=UTIF.decode(g.slice(10).buffer)[0];else if(t.readUshort(r,d)<300&&t.readUshort(r,d+4)<=12){var p=[];UTIF._readIFD(t,r,d,p,i+1,a),f.makerNote=p[0]}}}else if(console.log(l,"unknown TIFF tag type: ",U,"num:",I),0==u)return}return n.push(f),a.debug&&console.log("   ".repeat(i),"<<<---------------"),e},UTIF.toRGBA=function(t,r){const e=t.width,n=t.height,i=e*n,a=t.data;let o;switch(r){case HalfFloatType:o=new Uint16Array(4*i);break;case FloatType:o=new Float32Array(4*i);break;default:console.error("THREE.LogLuvLoader: Unsupported texture data type:",r)}let f=t.t262?t.t262[0]:2;const u=t.t258?Math.min(32,t.t258[0]):1;if(null==t.t262&&1==u&&(f=0),32845==f)for(let t=0;t<n;t++)for(let n=0;n<e;n++){const i=6*(t*e+n),f=4*(t*e+n);let u=a[i+1]<<8|a[i];u=Math.pow(2,(u+.5)/256-64);const l=(a[i+3]+.5)/410,U=(a[i+5]+.5)/410,I=9*l/(6*l-16*U+12),d=4*U/(6*l-16*U+12),h=I*u/d,F=(1-I-d)*u/d,s=2.69*h-1.276*u-.414*F,c=-1.022*h+1.978*u+.044*F,T=.061*h-.224*u+1.163*F;r===HalfFloatType?(o[f]=DataUtils.toHalfFloat(Math.min(s,65504)),o[f+1]=DataUtils.toHalfFloat(Math.min(c,65504)),o[f+2]=DataUtils.toHalfFloat(Math.min(T,65504)),o[f+3]=DataUtils.toHalfFloat(1)):(o[f]=s,o[f+1]=c,o[f+2]=T,o[f+3]=1)}else console.log("Unsupported Photometric interpretation: "+f);return o},UTIF._binBE={nextZero:function(t,r){for(;0!=t[r];)r++;return r},readUshort:function(t,r){return t[r]<<8|t[r+1]},readShort:function(t,r){var e=UTIF._binBE.ui8;return e[0]=t[r+1],e[1]=t[r+0],UTIF._binBE.i16[0]},readInt:function(t,r){var e=UTIF._binBE.ui8;return e[0]=t[r+3],e[1]=t[r+2],e[2]=t[r+1],e[3]=t[r+0],UTIF._binBE.i32[0]},readUint:function(t,r){var e=UTIF._binBE.ui8;return e[0]=t[r+3],e[1]=t[r+2],e[2]=t[r+1],e[3]=t[r+0],UTIF._binBE.ui32[0]},readASCII:function(t,r,e){for(var n="",i=0;i<e;i++)n+=String.fromCharCode(t[r+i]);return n},readFloat:function(t,r){for(var e=UTIF._binBE.ui8,n=0;n<4;n++)e[n]=t[r+3-n];return UTIF._binBE.fl32[0]},readDouble:function(t,r){for(var e=UTIF._binBE.ui8,n=0;n<8;n++)e[n]=t[r+7-n];return UTIF._binBE.fl64[0]},writeUshort:function(t,r,e){t[r]=e>>8&255,t[r+1]=255&e},writeInt:function(t,r,e){var n=UTIF._binBE.ui8;UTIF._binBE.i32[0]=e,t[r+3]=n[0],t[r+2]=n[1],t[r+1]=n[2],t[r+0]=n[3]},writeUint:function(t,r,e){t[r]=e>>24&255,t[r+1]=e>>16&255,t[r+2]=e>>8&255,t[r+3]=e>>0&255},writeASCII:function(t,r,e){for(var n=0;n<e.length;n++)t[r+n]=e.charCodeAt(n)},writeDouble:function(t,r,e){UTIF._binBE.fl64[0]=e;for(var n=0;n<8;n++)t[r+n]=UTIF._binBE.ui8[7-n]}},UTIF._binBE.ui8=new Uint8Array(8),UTIF._binBE.i16=new Int16Array(UTIF._binBE.ui8.buffer),UTIF._binBE.i32=new Int32Array(UTIF._binBE.ui8.buffer),UTIF._binBE.ui32=new Uint32Array(UTIF._binBE.ui8.buffer),UTIF._binBE.fl32=new Float32Array(UTIF._binBE.ui8.buffer),UTIF._binBE.fl64=new Float64Array(UTIF._binBE.ui8.buffer),UTIF._binLE={nextZero:UTIF._binBE.nextZero,readUshort:function(t,r){return t[r+1]<<8|t[r]},readShort:function(t,r){var e=UTIF._binBE.ui8;return e[0]=t[r+0],e[1]=t[r+1],UTIF._binBE.i16[0]},readInt:function(t,r){var e=UTIF._binBE.ui8;return e[0]=t[r+0],e[1]=t[r+1],e[2]=t[r+2],e[3]=t[r+3],UTIF._binBE.i32[0]},readUint:function(t,r){var e=UTIF._binBE.ui8;return e[0]=t[r+0],e[1]=t[r+1],e[2]=t[r+2],e[3]=t[r+3],UTIF._binBE.ui32[0]},readASCII:UTIF._binBE.readASCII,readFloat:function(t,r){for(var e=UTIF._binBE.ui8,n=0;n<4;n++)e[n]=t[r+n];return UTIF._binBE.fl32[0]},readDouble:function(t,r){for(var e=UTIF._binBE.ui8,n=0;n<8;n++)e[n]=t[r+n];return UTIF._binBE.fl64[0]},writeUshort:function(t,r,e){t[r]=255&e,t[r+1]=e>>8&255},writeInt:function(t,r,e){var n=UTIF._binBE.ui8;UTIF._binBE.i32[0]=e,t[r+0]=n[0],t[r+1]=n[1],t[r+2]=n[2],t[r+3]=n[3]},writeUint:function(t,r,e){t[r]=e>>>0&255,t[r+1]=e>>>8&255,t[r+2]=e>>>16&255,t[r+3]=e>>>24&255},writeASCII:UTIF._binBE.writeASCII},UTIF._copyTile=function(t,r,e,n,i,a,o,f){for(var u=Math.min(r,i-o),l=Math.min(e,a-f),U=0;U<l;U++)for(var I=(f+U)*i+o,d=U*r,h=0;h<u;h++)n[I+h]=t[d+h]};export{LogLuvLoader};